<html><head><base href="https://websim.ai/"><title>Windows XP Simulator</title><style>body{margin:0;padding:0;font-family:'Tahoma',sans-serif;overflow:hidden;user-select:none;}.desktop{width:100vw;height:100vh;position:relative;background-image:url('https://d7hftxdivxxvm.cloudfront.net/?quality=80&resize_to=width&src=https%3A%2F%2Fartsy-media-uploads.s3.amazonaws.com%2F2RNK1P0BYVrSCZEy_Sd1Ew%252F3417757448_4a6bdf36ce_o.jpg&width=910');background-size:cover;background-position:center;transition:background-color 0.3s ease;}.taskbar{position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(to bottom,#2584ff 0%,#0254cc 100%);display:flex;align-items:center;padding:0 2px;z-index:1000;transition:background 0.3s ease;}.start-button{background:linear-gradient(to bottom,#6cd82e 0%,#4ca916 100%);color:white;font-weight:bold;padding:2px 10px;border-radius:3px;margin-right:10px;cursor:pointer;transition:all 0.2s ease;}.start-button:hover{transform:scale(1.05);}.clock{margin-left:auto;color:white;font-size:11px;padding-right:10px;cursor:pointer;}.icon{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:move;color:white;text-shadow:1px 1px 2px black;transition:transform 0.2s ease;}.icon:hover{transform:scale(1.1);}.icon img{width:32px;height:32px;margin-bottom:5px;}.icon-label{font-size:12px;text-align:center;}.window{position:absolute;background:#ECE9D8;border:1px solid #0054E3;box-shadow:2px 2px 5px rgba(0,0,0,0.2);resize:both;overflow:auto;min-width:200px;min-height:150px;transition:all 0.3s ease;animation:windowFadeIn 0.3s ease;}.window-header{background:linear-gradient(to right,#0058E6,#3986FF);color:white;padding:5px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:move;transition:background 0.2s ease;}.window-header:hover{background:linear-gradient(to right,#0068F6,#4996FF);}.window-content{padding:10px;height:calc(100% - 40px);overflow:auto;}.close-btn,.minimize-btn,.maximize-btn{cursor:pointer;margin-left:5px;padding:2px 6px;border-radius:2px;transition:background 0.2s ease;}.close-btn:hover{background:rgba(255,255,255,0.2);}.minimize-btn:hover{background:rgba(255,255,255,0.2);}.maximize-btn:hover{background:rgba(255,255,255,0.2);}.folder-view{display:flex;flex-wrap:wrap;gap:30px;padding:15px;}.folder-icon{display:flex;flex-direction:column;align-items:center;width:80px;cursor:pointer;transition:transform 0.2s ease;}.folder-icon:hover{transform:scale(1.1);}.folder-icon img{width:48px;height:48px;margin-bottom:5px;}.folder-label{font-size:11px;text-align:center;color:black;} .folder-window{display:flex;height:100%;background:#fff;} .folder-sidebar{width:150px;background:linear-gradient(to bottom,#dbe9f9,#c2d8f0);padding:10px;font-size:12px;color:#000;} .folder-content{flex:1;overflow:auto;}.my-computer-content{display:flex;flex-wrap:wrap;gap:20px;padding:10px;}.drive-icon{display:flex;flex-direction:column;align-items:center;width:80px;cursor:pointer;transition:transform 0.2s ease;}.drive-icon:hover{transform:scale(1.1);}.drive-icon img{width:32px;height:32px;margin-bottom:5px;}.drive-label{font-size:11px;text-align:center;color:black;}.document-content{padding:10px;font-size:12px;}.psp-emu-window{width:100%;height:100%;border:none;}.maximized{position:fixed !important;top:0 !important;left:0 !important;width:100vw !important;height:calc(100vh - 30px) !important;z-index:999;}.psp-emu-container{position:relative;width:100%;height:100%;}.psp-emu-overlay{position:absolute;top:0;left:0;right:0;height:38px;background:#ECE9D8;z-index:1;}.start-menu{position:absolute;bottom:30px;left:0;width:380px;background:#D5E3FC;border:1px solid #0054E3;box-shadow:2px 2px 5px rgba(0,0,0,0.2);display:none;z-index:1001;animation:slideUp 0.2s ease;}.start-menu-header{background:linear-gradient(to right,#1758CA,#7DA3E8);color:white;padding:5px;font-weight:bold;font-size:14px;display:flex;align-items:center;}.start-menu-header img{width:24px;height:24px;margin-right:5px;}.start-menu-left{width:200px;background:#D5E3FC;padding:5px;}.start-menu-right{width:180px;background:#7DA3E8;padding:5px;}.start-menu-item{padding:5px;cursor:pointer;display:flex;align-items:center;transition:background 0.2s ease;}.start-menu-item:hover{background:#316AC5;color:white;}.start-menu-item img{width:24px;height:24px;margin-right:5px;}.start-menu-separator{height:1px;background:#7DA3E8;margin:5px 0;}.minimized{display:none;animation:windowMinimize 0.3s ease;}.taskbar-item{background:linear-gradient(to bottom,#f0f0f0,#e0e0e0);border:1px solid #999;padding:2px 5px;margin-right:2px;cursor:pointer;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;height:22px;line-height:22px;transition:all 0.2s ease;}.taskbar-item:hover{background:linear-gradient(to bottom,#fff,#f0f0f0);}.chrome-window{width:100%;height:calc(100% - 10px);border:none;}#taskbar-items{display:flex;flex-grow:1;overflow-x:hidden;}@keyframes windowFadeIn{from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}@keyframes slideUp{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}@keyframes windowMinimize{to{transform:scale(0.1);opacity:0;}}</style><style>.add-app-button{background:linear-gradient(to bottom,#ffa64d 0%,#d97a00 100%);color:white;font-weight:bold;padding:2px 10px;border-radius:3px;margin-right:10px;cursor:pointer;}</style><style>.context-menu{position:fixed;display:none;background:#f0f0f0;border:1px solid #666;z-index:1000;} .context-menu ul{list-style:none;margin:0;padding:5px 0;} .context-menu li{padding:4px 20px;white-space:nowrap;cursor:pointer;} .context-menu li:hover{background:#0a246a;color:#fff;} .context-menu.top{z-index:20000;} .open-menu-button{position:fixed;top:80px;right:20px;z-index:10001;cursor:move;}</style><link rel='stylesheet' href='about-modal.css'></head><body><div id="desktop" class="desktop"><div class="icon" style="top:20px;left:20px;" data-app="my-computer" title="My Computer"><img src="https://i.imgur.com/Rc7JRUI.png" alt="My Computer"><div class="icon-label">My Computer</div></div><div class="icon" style="top:100px;left:20px;" data-app="recycle-bin" title="Recycle Bin"><img src="https://i.imgur.com/AVKS9Rm.png" alt="Recycle Bin"><div class="icon-label">Recycle Bin</div></div><div class="icon" style="top:180px;left:20px;" data-app="my-documents" title="My Documents"><img src="https://cdn-icons-png.flaticon.com/512/3330/3330314.png" alt="My Documents"><div class="icon-label">My Documents</div></div><div class="icon" style="top:20px;left:120px;" data-app="notepad" title="Notepad - Text Editor"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991112.png" alt="Notepad"><div class="icon-label">Notepad</div></div><div class="icon" style="top:100px;left:120px;" data-app="calculator" title="Calculator"><img src="https://cdn-icons-png.flaticon.com/512/2698/2698011.png" alt="Calculator"><div class="icon-label">Calculator</div></div><div class="icon" style="top:180px;left:120px;" data-app="paint" title="Paint - Drawing Application"><img src="https://cdn-icons-png.flaticon.com/512/2965/2965230.png" alt="Paint"><div class="icon-label">Paint</div></div><div class="icon" style="top:20px;left:220px;" data-app="minesweeper" title="Minesweeper Game"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991423.png" alt="Minesweeper"><div class="icon-label">Minesweeper</div></div><div class="icon" style="top:100px;left:220px;" data-app="solitaire" title="Solitaire Card Game"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991495.png" alt="Solitaire"><div class="icon-label">Solitaire</div></div><div class="icon" style="top:180px;left:220px;" data-app="media-player" title="Windows Media Player"><img src="https://cdn-icons-png.flaticon.com/512/2965/2965307.png" alt="Media Player"><div class="icon-label">Media Player</div></div><div class="icon" style="top:260px;left:20px;" data-app="psp-emu" title="PSP Emulator"><img src="https://cdn-icons-png.flaticon.com/512/2949/2949874.png" alt="PSP EMU"><div class="icon-label">PSP EMU</div></div><div class="icon" style="top:340px;left:20px;" data-app="google-chrome" title="Google Chrome Browser"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/Google_Chrome_icon_%28February_2022%29.svg" alt="Google Chrome"><div class="icon-label">Google Chrome</div></div><div class="icon" style="top:20px;left:320px;" data-app="snake" title="Snake Game"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991206.png" alt="Snake"><div class="icon-label">Snake</div></div><div class="icon" style="top:100px;left:320px;" data-app="tictactoe" title="Tic-Tac-Toe"><img src="https://cdn-icons-png.flaticon.com/512/566/566294.png" alt="TicTacToe"><div class="icon-label">Tic-Tac-Toe</div></div><div class="icon" style="top:180px;left:320px;" data-app="task-manager" title="Task Manager"><img src="https://cdn-icons-png.flaticon.com/512/3079/3079404.png" alt="Task Manager"><div class="icon-label">Task Manager</div></div><div class="icon" style="top:260px;left:320px;" data-app="sticky-notes" title="Sticky Notes"><img src="https://cdn-icons-png.flaticon.com/512/2965/2965306.png" alt="Sticky Notes"><div class="icon-label">Sticky Notes</div></div><div class="icon" style="top:340px;left:320px;" data-app="calendar" title="Calendar"><img src="https://cdn-icons-png.flaticon.com/512/2693/2693507.png" alt="Calendar"><div class="icon-label">Calendar</div></div><div class="icon" style="top:420px;left:20px;" data-app="photo-viewer" title="Photo Viewer"><img src="https://cdn-icons-png.flaticon.com/512/3342/3342137.png" alt="Photo Viewer"><div class="icon-label">Photo Viewer</div></div><div class="icon" style="top:20px;left:420px;" data-app="cmd" title="Command Prompt"><img src="https://cdn-icons-png.flaticon.com/512/2721/2721297.png" alt="Command Prompt"><div class="icon-label">Command Prompt</div></div><div class="icon" style="top:100px;left:420px;" data-app="file-explorer" title="File Explorer"><img src="https://cdn-icons-png.flaticon.com/512/148/148947.png" alt="File Explorer"><div class="icon-label">File Explorer</div></div><div class="icon" style="top:180px;left:420px;" data-app="system-properties" title="System Properties"><img src="https://cdn-icons-png.flaticon.com/512/3094/3094830.png" alt="System Properties"><div class="icon-label">System</div></div><div class="icon" style="top:260px;left:420px;" data-app="volume-control" title="Volume Control"><img src="https://cdn-icons-png.flaticon.com/512/727/727269.png" alt="Volume"><div class="icon-label">Volume</div></div><div class="icon" style="top:340px;left:420px;" data-app="pong" title="Pong Game"><img src="https://cdn-icons-png.flaticon.com/512/889/889192.png" alt="Pong"><div class="icon-label">Pong</div></div><div class="icon" style="top:420px;left:420px;" data-app="breakout" title="Breakout Game"><img src="https://cdn-icons-png.flaticon.com/512/2917/2917995.png" alt="Breakout"><div class="icon-label">Breakout</div></div><div class="icon" style="top:20px;left:520px;" data-app="game-2048" title="2048 Game"><img src="https://cdn-icons-png.flaticon.com/512/3050/3050459.png" alt="2048"><div class="icon-label">2048</div></div><div class="icon" style="top:100px;left:520px;" data-app="system-monitor" title="System Monitor"><img src="https://cdn-icons-png.flaticon.com/512/2936/2936769.png" alt="Monitor"><div class="icon-label">Monitor</div></div><div class="icon" style="top:180px;left:520px;" data-app="clipboard" title="Clipboard Manager"><img src="https://cdn-icons-png.flaticon.com/512/3074/3074058.png" alt="Clipboard"><div class="icon-label">Clipboard</div></div><div class="taskbar"><div class="start-button">Start</div><div class="add-app-button">Add App</div><div id="taskbar-items"></div><div class="clock">12:00</div></div><div class="start-menu"><div class="start-menu-header"><img src="https://i.imgur.com/Rc7JRUI.png" alt="User Icon">User</div><div style="display:flex;"><div class="start-menu-left"><div class="start-menu-item" data-app="internet-explorer"><img src="https://i.imgur.com/s9HhTqB.png" alt="Internet Explorer">Internet Explorer</div><div class="start-menu-item" data-app="outlook-express"><img src="https://i.imgur.com/iJrBwfj.png" alt="Outlook Express">Outlook Express</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="my-computer"><img src="https://i.imgur.com/Rc7JRUI.png" alt="My Computer">My Computer</div><div class="start-menu-item" data-app="my-documents"><img src="https://cdn-icons-png.flaticon.com/512/3330/3330314.png" alt="My Documents">My Documents</div><div class="start-menu-item" data-app="control-panel"><img src="https://i.imgur.com/Mrqm7i6.png" alt="Control Panel">Control Panel</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="help"><img src="https://i.imgur.com/OQw2CwX.png" alt="Help and Support">Help and Support</div><div class="start-menu-item" data-app="search"><img src="https://i.imgur.com/0X6zIZd.png" alt="Search">Search</div><div class="start-menu-item" data-app="run"><img src="https://i.imgur.com/qgxGYQM.png" alt="Run">Run...</div></div><div class="start-menu-right"><div class="start-menu-item" data-app="notepad"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991112.png" alt="Notepad">Notepad</div><div class="start-menu-item" data-app="calculator"><img src="https://cdn-icons-png.flaticon.com/512/2698/2698011.png" alt="Calculator">Calculator</div><div class="start-menu-item" data-app="paint"><img src="https://cdn-icons-png.flaticon.com/512/2965/2965230.png" alt="Paint">Paint</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="minesweeper"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991423.png" alt="Minesweeper">Minesweeper</div><div class="start-menu-item" data-app="solitaire"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991495.png" alt="Solitaire">Solitaire</div><div class="start-menu-item" data-app="snake"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991206.png" alt="Snake">Snake</div><div class="start-menu-item" data-app="tictactoe"><img src="https://cdn-icons-png.flaticon.com/512/566/566294.png" alt="TicTacToe">Tic-Tac-Toe</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="task-manager"><img src="https://cdn-icons-png.flaticon.com/512/3079/3079404.png" alt="Task Manager">Task Manager</div><div class="start-menu-item" data-app="sticky-notes"><img src="https://cdn-icons-png.flaticon.com/512/2965/2965306.png" alt="Sticky Notes">Sticky Notes</div><div class="start-menu-item" data-app="calendar"><img src="https://cdn-icons-png.flaticon.com/512/2693/2693507.png" alt="Calendar">Calendar</div><div class="start-menu-item" data-app="photo-viewer"><img src="https://cdn-icons-png.flaticon.com/512/3342/3342137.png" alt="Photo Viewer">Photo Viewer</div><div class="start-menu-item" data-app="media-player"><img src="https://cdn-icons-png.flaticon.com/512/2965/2965307.png" alt="Media Player">Media Player</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="psp-emu"><img src="https://cdn-icons-png.flaticon.com/512/2949/2949874.png" alt="PSP EMU">PSP EMU</div><div class="start-menu-item" data-app="google-chrome"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/Google_Chrome_icon_%28February_2022%29.svg" alt="Google Chrome">Google Chrome</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="cmd"><img src="https://cdn-icons-png.flaticon.com/512/2721/2721297.png" alt="CMD">Command Prompt</div><div class="start-menu-item" data-app="file-explorer"><img src="https://cdn-icons-png.flaticon.com/512/148/148947.png" alt="Explorer">File Explorer</div><div class="start-menu-item" data-app="system-properties"><img src="https://cdn-icons-png.flaticon.com/512/3094/3094830.png" alt="System">System Properties</div><div class="start-menu-item" data-app="volume-control"><img src="https://cdn-icons-png.flaticon.com/512/727/727269.png" alt="Volume">Volume Control</div><div class="start-menu-item" data-app="system-monitor"><img src="https://cdn-icons-png.flaticon.com/512/2936/2936769.png" alt="Monitor">System Monitor</div><div class="start-menu-item" data-app="clipboard"><img src="https://cdn-icons-png.flaticon.com/512/3074/3074058.png" alt="Clipboard">Clipboard</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="pong"><img src="https://cdn-icons-png.flaticon.com/512/889/889192.png" alt="Pong">Pong</div><div class="start-menu-item" data-app="breakout"><img src="https://cdn-icons-png.flaticon.com/512/2917/2917995.png" alt="Breakout">Breakout</div><div class="start-menu-item" data-app="game-2048"><img src="https://cdn-icons-png.flaticon.com/512/3050/3050459.png" alt="2048">2048</div><div class="start-menu-separator"></div><div class="start-menu-item" data-app="log-off"><img src="https://i.imgur.com/BpMCFCX.png" alt="Log Off">Log Off</div><div class="start-menu-item" data-app="turn-off"><img src="https://i.imgur.com/TftAWxI.png" alt="Turn Off Computer">Turn Off Computer</div></div></div></div></div><script>const apps={
  'notepad': {
    title: 'Notepad',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#fff;">
        <div style="background:#ECE9D8;padding:2px;border-bottom:1px solid #999;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button onclick="document.querySelector('.notepad-text').value=''" style="padding:2px 8px;">New</button>
          <button onclick="saveNotepad()" style="padding:2px 8px;">Save</button>
          <button onclick="loadNotepad()" style="padding:2px 8px;">Load</button>
          <div style="border-left:1px solid #999;height:20px;"></div>
          <input type="text" id="notepad-search" placeholder="Search..." style="padding:2px 6px;width:120px;border:1px solid #999;">
          <button onclick="searchNotepad()" style="padding:2px 8px;">Find</button>
          <div style="border-left:1px solid #999;height:20px;"></div>
          <button onclick="countWords()" style="padding:2px 8px;">Word Count</button>
          <span id="notepad-stats" style="font-size:11px;color:#666;"></span>
        </div>
        <textarea class="notepad-text" oninput="updateNotepadStats()" style="flex:1;border:none;padding:10px;font-family:Consolas,monospace;font-size:13px;resize:none;outline:none;"></textarea>
      </div>
    `
  },
  'calculator': {
    title: 'Calculator',
    content: `
      <div style="background:#ECE9D8;padding:10px;width:220px;">
        <div style="text-align:left;margin-bottom:5px;font-size:12px;color:#666;">Memory: <span id="calc-memory">0</span></div>
        <input type="text" id="calc-display" readonly style="width:100%;height:40px;font-size:20px;text-align:right;margin-bottom:10px;border:2px inset;background:#fff;padding:5px;box-sizing:border-box;">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:4px;">
          <button onclick="calcMemoryAdd()" style="padding:8px;font-size:14px;background:#d4d0c8;">M+</button>
          <button onclick="calcMemorySub()" style="padding:8px;font-size:14px;background:#d4d0c8;">M-</button>
          <button onclick="calcMemoryRecall()" style="padding:8px;font-size:14px;background:#d4d0c8;">MR</button>
          <button onclick="calcMemoryClear()" style="padding:8px;font-size:14px;background:#d4d0c8;">MC</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;">
          <button onclick="calcClick('7')" style="padding:10px;font-size:16px;">7</button>
          <button onclick="calcClick('8')" style="padding:10px;font-size:16px;">8</button>
          <button onclick="calcClick('9')" style="padding:10px;font-size:16px;">9</button>
          <button onclick="calcClick('/')" style="padding:10px;font-size:16px;">/</button>
          <button onclick="calcClick('4')" style="padding:10px;font-size:16px;">4</button>
          <button onclick="calcClick('5')" style="padding:10px;font-size:16px;">5</button>
          <button onclick="calcClick('6')" style="padding:10px;font-size:16px;">6</button>
          <button onclick="calcClick('*')" style="padding:10px;font-size:16px;">*</button>
          <button onclick="calcClick('1')" style="padding:10px;font-size:16px;">1</button>
          <button onclick="calcClick('2')" style="padding:10px;font-size:16px;">2</button>
          <button onclick="calcClick('3')" style="padding:10px;font-size:16px;">3</button>
          <button onclick="calcClick('-')" style="padding:10px;font-size:16px;">-</button>
          <button onclick="calcClick('0')" style="padding:10px;font-size:16px;">0</button>
          <button onclick="calcClick('.')" style="padding:10px;font-size:16px;">.</button>
          <button onclick="calcEquals()" style="padding:10px;font-size:16px;">=</button>
          <button onclick="calcClick('+')" style="padding:10px;font-size:16px;">+</button>
          <button onclick="calcClear()" style="padding:10px;font-size:16px;grid-column:span 2;">C</button>
          <button onclick="calcBackspace()" style="padding:10px;font-size:16px;grid-column:span 2;">‚å´</button>
        </div>
      </div>
    `
  },
  'paint': {
    title: 'Paint',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#ECE9D8;">
        <div style="background:#ECE9D8;padding:5px;border-bottom:1px solid #999;display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
          <div style="display:flex;gap:3px;border-right:1px solid #999;padding-right:5px;">
            <button id="tool-brush" onclick="setPaintTool('brush')" style="padding:4px 8px;background:#fff;border:2px inset #999;">üñåÔ∏è</button>
            <button id="tool-rectangle" onclick="setPaintTool('rectangle')" style="padding:4px 8px;border:2px outset #999;">‚ñ≠</button>
            <button id="tool-circle" onclick="setPaintTool('circle')" style="padding:4px 8px;border:2px outset #999;">‚≠ï</button>
            <button id="tool-eraser" onclick="setPaintTool('eraser')" style="padding:4px 8px;border:2px outset #999;">üßπ</button>
          </div>
          <input type="color" id="paint-color" value="#000000" style="width:40px;height:30px;">
          <label>Size:</label>
          <input type="range" id="paint-size" min="1" max="20" value="3" style="width:100px;">
          <button onclick="clearCanvas()" style="padding:4px 10px;">Clear</button>
          <button onclick="fillCanvas()" style="padding:4px 10px;">Fill</button>
        </div>
        <canvas id="paint-canvas" style="flex:1;background:#fff;cursor:crosshair;"></canvas>
      </div>
    `
  },
  'minesweeper': {
    title: 'Minesweeper',
    content: `
      <div style="background:#ECE9D8;padding:10px;">
        <div style="text-align:center;margin-bottom:10px;">
          <button onclick="initMinesweeper()" style="padding:5px 15px;font-size:16px;">üôÇ New Game</button>
          <div style="margin-top:5px;">Mines: <span id="mines-count">10</span></div>
        </div>
        <div id="minesweeper-grid" style="display:inline-block;background:#999;border:3px outset #ECE9D8;"></div>
      </div>
    `
  },
  'solitaire': {
    title: 'Solitaire',
    content: `
      <div style="background:#0a8000;padding:20px;text-align:center;height:100%;">
        <h2 style="color:#fff;margin-bottom:20px;">üÉè Solitaire</h2>
        <button onclick="initSolitaire()" style="padding:10px 20px;font-size:16px;">New Game</button>
        <div id="solitaire-game" style="margin-top:20px;"></div>
      </div>
    `
  },
  'snake': {
    title: 'Snake Game',
    content: `
      <div style="background:#000;padding:20px;text-align:center;height:100%;">
        <div style="color:#0f0;margin-bottom:10px;">Score: <span id="snake-score">0</span> | High: <span id="snake-high">0</span></div>
        <canvas id="snake-canvas" width="400" height="400" style="border:2px solid #0f0;background:#000;"></canvas>
        <div style="margin-top:10px;">
          <button onclick="startSnake()" style="padding:8px 20px;margin:5px;">Start</button>
          <button onclick="pauseSnake()" style="padding:8px 20px;margin:5px;">Pause</button>
        </div>
        <div style="color:#0f0;margin-top:10px;font-size:12px;">Use Arrow Keys to move</div>
      </div>
    `
  },
  'tictactoe': {
    title: 'Tic-Tac-Toe',
    content: `
      <div style="background:#ECE9D8;padding:20px;text-align:center;">
        <h3>Tic-Tac-Toe</h3>
        <div style="margin:10px 0;">Player: <span id="ttt-player">X</span></div>
        <div id="ttt-board" style="display:inline-grid;grid-template-columns:repeat(3,80px);gap:5px;margin:10px;"></div>
        <button onclick="resetTicTacToe()" style="padding:8px 20px;margin-top:10px;">New Game</button>
        <div id="ttt-status" style="margin-top:10px;font-weight:bold;"></div>
      </div>
    `
  },
  'task-manager': {
    title: 'Task Manager',
    content: `
      <div style="background:#ECE9D8;padding:10px;height:100%;">
        <div style="background:#fff;border:1px solid #999;padding:10px;height:calc(100% - 60px);overflow:auto;">
          <table style="width:100%;border-collapse:collapse;" id="task-list">
            <thead>
              <tr style="background:#ddd;text-align:left;">
                <th style="padding:5px;border:1px solid #999;">Application</th>
                <th style="padding:5px;border:1px solid #999;">Status</th>
                <th style="padding:5px;border:1px solid #999;">Action</th>
              </tr>
            </thead>
            <tbody id="task-tbody"></tbody>
          </table>
        </div>
        <div style="margin-top:10px;">
          <button onclick="refreshTaskManager()" style="padding:5px 15px;">Refresh</button>
          <button onclick="closeAllWindows()" style="padding:5px 15px;margin-left:5px;">Close All</button>
        </div>
      </div>
    `
  },
  'sticky-notes': {
    title: 'Sticky Notes',
    content: `
      <div style="background:#fff3cd;padding:10px;height:100%;font-family:Comic Sans MS,cursive;">
        <textarea id="sticky-text" style="width:100%;height:calc(100% - 40px);border:none;background:transparent;resize:none;font-size:14px;font-family:inherit;" placeholder="Type your note here..."></textarea>
        <div style="margin-top:5px;">
          <button onclick="saveStickyNote()" style="padding:4px 10px;">Save</button>
          <button onclick="loadStickyNote()" style="padding:4px 10px;">Load</button>
          <button onclick="clearStickyNote()" style="padding:4px 10px;">Clear</button>
        </div>
      </div>
    `
  },
  'calendar': {
    title: 'Calendar',
    content: `
      <div style="background:#ECE9D8;padding:15px;text-align:center;">
        <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
          <button onclick="calendarPrevMonth()" style="padding:5px 10px;">‚óÄ</button>
          <h3 id="calendar-month" style="margin:0;"></h3>
          <button onclick="calendarNextMonth()" style="padding:5px 10px;">‚ñ∂</button>
        </div>
        <div id="calendar-grid" style="display:grid;grid-template-columns:repeat(7,40px);gap:2px;margin:10px auto;width:fit-content;"></div>
        <button onclick="calendarToday()" style="padding:5px 15px;margin-top:10px;">Today</button>
      </div>
    `
  },
  'photo-viewer': {
    title: 'Photo Viewer',
    content: `
      <div style="background:#2c2c2c;padding:10px;text-align:center;height:100%;display:flex;flex-direction:column;">
        <div style="margin-bottom:10px;">
          <input type="text" id="photo-url" placeholder="Enter image URL" style="width:70%;padding:5px;">
          <button onclick="loadPhoto()" style="padding:5px 15px;margin-left:5px;">Load</button>
        </div>
        <div style="flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;" id="photo-container">
          <div style="color:#999;">Enter an image URL above to view</div>
        </div>
      </div>
    `
  },
  'media-player': {
    title: 'Windows Media Player',
    content: `
      <div style="background:linear-gradient(to bottom,#0c3d6e,#000);padding:15px;color:#fff;height:100%;">
        <h3 style="text-align:center;margin-bottom:15px;">üéµ Media Player</h3>
        <div style="background:#000;padding:10px;border-radius:5px;margin-bottom:10px;">
          <input type="text" id="media-url" placeholder="Enter YouTube/Media URL" style="width:100%;padding:8px;box-sizing:border-box;margin-bottom:5px;">
          <button onclick="loadMedia()" style="padding:6px 15px;">Load</button>
        </div>
        <div id="media-container" style="background:#000;min-height:200px;display:flex;align-items:center;justify-content:center;color:#666;">
          No media loaded
        </div>
        <div style="text-align:center;margin-top:10px;">
          <button onclick="alert('Play')" style="padding:8px 15px;margin:2px;">‚ñ∂Ô∏è</button>
          <button onclick="alert('Pause')" style="padding:8px 15px;margin:2px;">‚è∏Ô∏è</button>
          <button onclick="alert('Stop')" style="padding:8px 15px;margin:2px;">‚èπÔ∏è</button>
        </div>
      </div>
    `
  },
  'my-computer': {
    title: 'My Computer',
    content: `
      <div class="folder-window">
  <div class="folder-sidebar">
    <div style="font-weight:bold;margin-bottom:10px;">System Tasks</div>
    <div style="font-size:11px;color:#666;">View system information</div>
  </div>
  <div class="folder-content">
    <div class="my-computer-content">
        <div class="drive-icon" onclick="explorerNavigate('C:\\\\')" style="cursor:pointer;">
          <img src="https://i.imgur.com/Q3SMT9S.png" alt="Local Disk (C:)">
          <div class="drive-label">Local Disk (C:)</div>
        </div>
        <div class="drive-icon" onclick="createWindow('file-explorer')" style="cursor:pointer;">
          <img src="https://cdn-icons-png.flaticon.com/512/148/148947.png" alt="File Explorer">
          <div class="drive-label">File Explorer</div>
        </div>
        <div class="drive-icon" onclick="createWindow('recycle-bin')" style="cursor:pointer;">
          <img src="https://i.imgur.com/AVKS9Rm.png" alt="Recycle Bin">
          <div class="drive-label">Recycle Bin</div>
        </div>
      </div>
    </div>
  </div>
</div>
    `
  },
  'recycle-bin': {
    title: 'Recycle Bin',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#fff;">
        <div style="background:#ECE9D8;padding:5px;border-bottom:1px solid #999;display:flex;gap:5px;">
          <button onclick="recycleBinRefresh()" style="padding:4px 10px;">‚ü≥ Refresh</button>
          <button onclick="recycleBinEmpty()" style="padding:4px 10px;background:#ffcccc;">üóëÔ∏è Empty Recycle Bin</button>
        </div>
        <div id="recycle-content" style="flex:1;padding:15px;overflow-y:auto;"></div>
      </div>
    `
  },
  'my-documents': {
    title: 'My Documents',
    content: `
      <div class="folder-window">
  <div class="folder-sidebar">My Documents Tasks</div>
  <div class="folder-content">
    <div class="folder-view">
        <div class="folder-icon">
          <img src="https://cdn-icons-png.flaticon.com/512/3330/3330314.png" alt="New Text Document">
          <div class="folder-label">New Text Document</div>
        </div>
        <div class="folder-icon">
          <img src="https://cdn-icons-png.flaticon.com/512/3330/3330314.png" alt="Resume">
          <div class="folder-label">Resume.doc</div>
        </div>
      </div>
    </div>
  </div>
</div>
    `
  },
  'psp-emu': {
    title: 'PSP EMU',
    content: `
      <div class="psp-emu-container">
        <div class="psp-emu-overlay"></div>
        <iframe class="psp-emu-window" src="https://websim.ai/c/BZhZd0JIqanPgCu5m"></iframe>
      </div>
    `
  },
  'google-chrome': {
    title: 'Google Chrome',
    content: `
      <iframe class="chrome-window" src="https://www.google.com/webhp?igu=1"></iframe>
    `
  },
  'internet-explorer': {
    title: 'Internet Explorer',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#ECE9D8;">
        <div style="background:#ECE9D8;padding:5px;border-bottom:1px solid #999;display:flex;gap:5px;align-items:center;">
          <button onclick="ieNavigate(-1)" style="padding:4px 10px;">‚Üê</button>
          <button onclick="ieNavigate(1)" style="padding:4px 10px;">‚Üí</button>
          <button onclick="ieRefresh()" style="padding:4px 10px;">‚ü≥</button>
          <button onclick="ieHome()" style="padding:4px 10px;">üè†</button>
          <input type="text" id="ie-url" placeholder="Enter URL..." value="https://www.bing.com" style="flex:1;padding:4px 8px;border:1px solid #999;">
          <button onclick="ieGo()" style="padding:4px 12px;">Go</button>
        </div>
        <iframe id="ie-frame" style="flex:1;border:none;background:#fff;"></iframe>
      </div>
    `
  },
  'outlook-express': {
    title: 'Outlook Express',
    content: `
      <div style="display:flex;height:100%;background:#fff;">
        <div style="width:150px;background:#ECE9D8;border-right:1px solid #999;padding:10px;">
          <h4 style="margin:0 0 10px 0;">Folders</h4>
          <div onclick="showEmailFolder('inbox')" style="padding:5px;cursor:pointer;background:#fff;margin-bottom:2px;">üì• Inbox (3)</div>
          <div onclick="showEmailFolder('sent')" style="padding:5px;cursor:pointer;">üì§ Sent Items</div>
          <div onclick="showEmailFolder('drafts')" style="padding:5px;cursor:pointer;">üìù Drafts</div>
          <div onclick="showEmailFolder('trash')" style="padding:5px;cursor:pointer;">üóëÔ∏è Deleted</div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;">
          <div style="background:#ECE9D8;padding:5px;border-bottom:1px solid #999;">
            <button onclick="composeEmail()" style="padding:4px 12px;">üìß New Email</button>
            <button onclick="refreshEmails()" style="padding:4px 12px;margin-left:5px;">‚ü≥ Refresh</button>
          </div>
          <div id="email-list" style="flex:1;overflow:auto;padding:10px;">
            <div style="border-bottom:1px solid #ccc;padding:10px;cursor:pointer;background:#e8f4ff;">
              <strong>Welcome to Outlook Express!</strong><br>
              <small>From: Microsoft | Today 9:00 AM</small><br>
              <span style="color:#666;">Your email client is ready to use...</span>
            </div>
            <div style="border-bottom:1px solid #ccc;padding:10px;cursor:pointer;">
              <strong>Windows XP Update</strong><br>
              <small>From: System | Yesterday</small><br>
              <span style="color:#666;">Important security updates available...</span>
            </div>
            <div style="border-bottom:1px solid #ccc;padding:10px;cursor:pointer;">
              <strong>Reminder: Check your settings</strong><br>
              <small>From: Admin | 2 days ago</small><br>
              <span style="color:#666;">Please review your account settings...</span>
            </div>
          </div>
        </div>
      </div>
    `
  },
  'control-panel': {
    title: 'Control Panel',
    content: `
      <div style="padding:20px;background:#fff;height:100%;overflow:auto;">
        <h2 style="margin-top:0;">Control Panel</h2>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
          <div style="border:1px solid #999;padding:15px;background:#f0f0f0;cursor:pointer;" onclick="showThemeSettings()">
            <h3 style="margin:0 0 10px 0;">üé® Appearance and Themes</h3>
            <p style="margin:0;font-size:12px;">Change desktop theme, wallpaper, and colors</p>
          </div>
          <div style="border:1px solid #999;padding:15px;background:#f0f0f0;cursor:pointer;" onclick="showDisplaySettings()">
            <h3 style="margin:0 0 10px 0;">üñ•Ô∏è Display Settings</h3>
            <p style="margin:0;font-size:12px;">Adjust screen resolution and window size</p>
          </div>
          <div style="border:1px solid #999;padding:15px;background:#f0f0f0;cursor:pointer;" onclick="showSoundSettings()">
            <h3 style="margin:0 0 10px 0;">üîä Sounds and Audio</h3>
            <p style="margin:0;font-size:12px;">Configure sound effects and volume</p>
          </div>
          <div style="border:1px solid #999;padding:15px;background:#f0f0f0;cursor:pointer;" onclick="showSystemInfo()">
            <h3 style="margin:0 0 10px 0;">‚ÑπÔ∏è System Information</h3>
            <p style="margin:0;font-size:12px;">View system details and performance</p>
          </div>
          <div style="border:1px solid #999;padding:15px;background:#f0f0f0;cursor:pointer;" onclick="showStorageSettings()">
            <h3 style="margin:0 0 10px 0;">üíæ Storage Management</h3>
            <p style="margin:0;font-size:12px;">Manage disk space and localStorage</p>
          </div>
          <div style="border:1px solid #999;padding:15px;background:#f0f0f0;cursor:pointer;" onclick="showClockSettings()">
            <h3 style="margin:0 0 10px 0;">üïê Date and Time</h3>
            <p style="margin:0;font-size:12px;">Toggle between 12/24 hour clock format</p>
          </div>
        </div>
      </div>
    `
  },
  'help': {
    title: 'Help and Support',
    content: `
      <div style="padding: 20px; text-align: center;">
        <h2>Help and Support</h2>
        <p>How can we assist you today?</p>
      </div>
    `
  },
  'search': {
    title: 'Search',
    content: `
      <div style="padding: 20px; text-align: center;">
        <h2>Search</h2>
        <p>Find files and folders</p>
      </div>
    `
  },
  'run': {
    title: 'Run',
    content: `
      <div style="padding: 20px; text-align: center;">
        <h2>Run</h2>
        <input type="text" placeholder="Type the name of a program, folder, document, or Internet resource">
      </div>
    `
  },
  'email': {
    title: 'E-mail',
    content: `
      <div style="padding: 20px; text-align: center;">
        <h2>E-mail</h2>
        <p>Compose a new message</p>
      </div>
    `
  },
  'cmd': {
    title: 'Command Prompt',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#000;color:#c0c0c0;font-family:'Consolas',monospace;font-size:14px;">
        <div style="padding:10px;border-bottom:1px solid #333;">
          Microsoft Windows XP [Version 5.1.2600]<br>
          (C) Copyright 1985-2001 Microsoft Corp.
        </div>
        <div id="cmd-output" style="flex:1;padding:10px;overflow-y:auto;"></div>
        <div style="padding:10px;display:flex;align-items:center;border-top:1px solid #333;">
          <span id="cmd-prompt">C:\\Users\\&gt;</span>
          <input type="text" id="cmd-input" onkeydown="cmdKeyHandler(event)" style="flex:1;background:transparent;border:none;color:#c0c0c0;outline:none;font-family:inherit;font-size:inherit;margin-left:5px;">
        </div>
      </div>
    `
  },
  'file-explorer': {
    title: 'File Explorer',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#fff;">
        <div style="background:#ECE9D8;padding:5px;border-bottom:1px solid #999;display:flex;gap:5px;flex-wrap:wrap;">
          <button onclick="explorerBack()" style="padding:4px 10px;">‚Üê</button>
          <button onclick="explorerForward()" style="padding:4px 10px;">‚Üí</button>
          <button onclick="explorerUp()" style="padding:4px 10px;">‚Üë</button>
          <input type="text" id="explorer-path" value="C:\\" readonly style="flex:1;min-width:150px;padding:4px 8px;border:1px solid #999;">
          <button onclick="explorerRefresh()" style="padding:4px 10px;">‚ü≥</button>
          <button onclick="explorerNewFile()" style="padding:4px 10px;background:#90EE90;">üìÑ New File</button>
          <button onclick="explorerNewFolder()" style="padding:4px 10px;background:#87CEEB;">üìÅ New Folder</button>
        </div>
        <div style="display:flex;flex:1;overflow:hidden;">
          <div style="width:180px;background:#ECE9D8;border-right:1px solid #999;padding:10px;overflow-y:auto;">
            <div style="font-weight:bold;margin-bottom:10px;">Folders</div>
            <div onclick="explorerNavigate('C:\\\\Desktop')" style="padding:5px;cursor:pointer;margin-bottom:2px;">üìÅ Desktop</div>
            <div onclick="explorerNavigate('C:\\\\My Documents')" style="padding:5px;cursor:pointer;">üìÅ My Documents</div>
            <div onclick="explorerNavigate('C:\\\\My Pictures')" style="padding:5px;cursor:pointer;">üìÅ My Pictures</div>
            <div onclick="explorerNavigate('C:\\\\My Music')" style="padding:5px;cursor:pointer;">üìÅ My Music</div>
            <div onclick="explorerNavigate('C:\\\\Program Files')" style="padding:5px;cursor:pointer;">üìÅ Program Files</div>
          </div>
          <div id="explorer-content" style="flex:1;padding:15px;overflow-y:auto;"></div>
        </div>
      </div>
    `
  },
  'system-properties': {
    title: 'System Properties',
    content: `
      <div style="padding:20px;background:#ECE9D8;height:100%;overflow:auto;">
        <h2>System Properties</h2>
        <div style="background:#fff;border:1px solid #999;padding:15px;margin-bottom:10px;">
          <h3 style="margin-top:0;">Computer</h3>
          <p><strong>System:</strong> Windows XP Professional Simulator</p>
          <p><strong>Processor:</strong> Intel Pentium 4 (Simulated)</p>
          <p><strong>Memory (RAM):</strong> <span id="sys-ram">512 MB</span></p>
          <p><strong>Computer Name:</strong> <span id="sys-name">DESKTOP-XP</span></p>
        </div>
        <div style="background:#fff;border:1px solid #999;padding:15px;margin-bottom:10px;">
          <h3 style="margin-top:0;">Performance</h3>
          <p><strong>CPU Usage:</strong> <span id="sys-cpu">0%</span></p>
          <p><strong>Memory Usage:</strong> <span id="sys-mem">0%</span></p>
          <p><strong>Uptime:</strong> <span id="sys-uptime">0:00:00</span></p>
        </div>
        <button onclick="updateSystemProperties()" style="padding:8px 20px;">Refresh</button>
      </div>
    `
  },
  'volume-control': {
    title: 'Volume Control',
    content: `
      <div style="background:#ECE9D8;padding:20px;text-align:center;">
        <h3>Master Volume</h3>
        <div style="display:flex;flex-direction:column;align-items:center;gap:20px;margin:20px 0;">
          <div style="writing-mode:bt-lr;height:200px;display:flex;flex-direction:column;align-items:center;">
            <input type="range" id="master-volume" min="0" max="100" value="75" orient="vertical" oninput="updateVolume()" style="writing-mode:bt-lr;width:200px;transform:rotate(-90deg);">
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <button onclick="toggleMute()" id="mute-btn" style="padding:10px 20px;">üîä Mute</button>
            <span id="volume-display" style="font-size:24px;font-weight:bold;">75%</span>
          </div>
        </div>
        <div style="margin-top:20px;">
          <label><input type="checkbox" id="sound-effects" checked> Enable sound effects</label>
        </div>
      </div>
    `
  },
  'pong': {
    title: 'Pong Game',
    content: `
      <div style="background:#000;padding:20px;text-align:center;height:100%;">
        <div style="color:#fff;margin-bottom:10px;">
          <span style="font-size:24px;">Player: <span id="pong-score1">0</span></span>
          <span style="margin:0 40px;">|</span>
          <span style="font-size:24px;">Computer: <span id="pong-score2">0</span></span>
        </div>
        <canvas id="pong-canvas" width="600" height="400" style="border:2px solid #fff;background:#000;"></canvas>
        <div style="margin-top:10px;">
          <button onclick="startPong()" style="padding:8px 20px;margin:5px;">Start Game</button>
          <button onclick="pausePong()" style="padding:8px 20px;margin:5px;">Pause</button>
        </div>
        <div style="color:#fff;margin-top:10px;font-size:12px;">Use W and S keys to move paddle</div>
      </div>
    `
  },
  'breakout': {
    title: 'Breakout',
    content: `
      <div style="background:#000;padding:20px;text-align:center;height:100%;">
        <div style="color:#fff;margin-bottom:10px;">
          Score: <span id="breakout-score">0</span> | Lives: <span id="breakout-lives">3</span> | Level: <span id="breakout-level">1</span>
        </div>
        <canvas id="breakout-canvas" width="600" height="500" style="border:2px solid #fff;background:#000;"></canvas>
        <div style="margin-top:10px;">
          <button onclick="startBreakout()" style="padding:8px 20px;margin:5px;">Start Game</button>
          <button onclick="pauseBreakout()" style="padding:8px 20px;margin:5px;">Pause</button>
        </div>
        <div style="color:#fff;margin-top:10px;font-size:12px;">Use Arrow Keys or Mouse to move paddle</div>
      </div>
    `
  },
  'game-2048': {
    title: '2048 Game',
    content: `
      <div style="background:#faf8ef;padding:20px;text-align:center;">
        <h2 style="color:#776e65;">2048</h2>
        <div style="margin:10px 0;">
          <span style="font-size:18px;color:#776e65;">Score: <span id="game2048-score" style="font-weight:bold;">0</span></span>
          <button onclick="init2048()" style="padding:8px 20px;margin-left:20px;background:#8f7a66;color:#fff;border:none;border-radius:3px;cursor:pointer;">New Game</button>
        </div>
        <div id="game2048-grid" style="display:inline-block;background:#bbada0;padding:10px;border-radius:10px;margin:20px auto;"></div>
        <div style="color:#776e65;margin-top:10px;font-size:14px;">Use Arrow Keys to play</div>
      </div>
    `
  },
  'system-monitor': {
    title: 'System Monitor',
    content: `
      <div style="background:#ECE9D8;padding:15px;height:100%;overflow:auto;">
        <h3>System Monitor</h3>
        <div style="background:#fff;border:1px solid #999;padding:10px;margin-bottom:10px;">
          <h4 style="margin-top:0;">CPU Usage</h4>
          <div style="background:#e0e0e0;height:20px;border:1px solid #999;position:relative;">
            <div id="monitor-cpu-bar" style="background:#0f0;height:100%;width:0%;transition:width 0.5s;"></div>
          </div>
          <span id="monitor-cpu-text">0%</span>
        </div>
        <div style="background:#fff;border:1px solid #999;padding:10px;margin-bottom:10px;">
          <h4 style="margin-top:0;">Memory Usage</h4>
          <div style="background:#e0e0e0;height:20px;border:1px solid #999;position:relative;">
            <div id="monitor-mem-bar" style="background:#00f;height:100%;width:0%;transition:width 0.5s;"></div>
          </div>
          <span id="monitor-mem-text">0 KB / 512 MB</span>
        </div>
        <div style="background:#fff;border:1px solid #999;padding:10px;margin-bottom:10px;">
          <h4 style="margin-top:0;">Active Processes</h4>
          <div id="monitor-processes" style="max-height:200px;overflow-y:auto;"></div>
        </div>
        <button onclick="refreshSystemMonitor()" style="padding:8px 20px;">Refresh</button>
      </div>
    `
  },
  'clipboard': {
    title: 'Clipboard Manager',
    content: `
      <div style="background:#ECE9D8;padding:15px;height:100%;display:flex;flex-direction:column;">
        <h3 style="margin-top:0;">Clipboard Manager</h3>
        <div style="margin-bottom:10px;">
          <input type="text" id="clip-input" placeholder="Enter text to copy..." style="width:100%;padding:8px;box-sizing:border-box;margin-bottom:5px;">
          <button onclick="clipboardCopy()" style="padding:6px 15px;">Copy</button>
          <button onclick="clipboardPaste()" style="padding:6px 15px;">Paste</button>
          <button onclick="clipboardClear()" style="padding:6px 15px;">Clear</button>
        </div>
        <div style="background:#fff;border:1px solid #999;flex:1;padding:10px;overflow-y:auto;">
          <h4 style="margin-top:0;">Clipboard History:</h4>
          <div id="clipboard-history"></div>
        </div>
      </div>
    `
  },
  'mp3-player': {
    title: 'MP3 Player',
    content: `
      <div style="background:linear-gradient(to bottom,#1e3a5f,#0d1b2a);padding:20px;color:#fff;height:100%;display:flex;flex-direction:column;">
        <h3 style="text-align:center;margin:0 0 15px 0;">üéµ MP3 Player</h3>
        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:8px;margin-bottom:15px;">
          <input type="file" id="mp3-file" accept="audio/*" style="margin-bottom:10px;color:#fff;">
          <div id="mp3-info" style="font-size:14px;margin-top:10px;color:#aaa;">No file loaded</div>
        </div>
        <audio id="mp3-audio" style="width:100%;margin-bottom:15px;" controls></audio>
        <div id="mp3-playlist" style="flex:1;background:rgba(0,0,0,0.3);padding:10px;border-radius:5px;overflow-y:auto;margin-bottom:10px;">
          <div style="color:#888;text-align:center;padding:20px;">Playlist Empty</div>
        </div>
        <div style="text-align:center;">
          <button onclick="clearPlaylist()" style="padding:8px 15px;background:#c0392b;color:#fff;border:none;border-radius:4px;cursor:pointer;">Clear Playlist</button>
        </div>
      </div>
    `
  },
  'image-viewer': {
    title: 'Image Viewer',
    content: `
      <div style="background:#2c2c2c;padding:15px;height:100%;display:flex;flex-direction:column;color:#fff;">
        <div style="background:#1a1a1a;padding:10px;margin-bottom:10px;border-radius:5px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <input type="file" id="image-file" accept="image/*" style="color:#fff;">
          <button onclick="rotateImage(90)" style="padding:6px 12px;">‚Üª Rotate Right</button>
          <button onclick="rotateImage(-90)" style="padding:6px 12px;">‚Ü∫ Rotate Left</button>
          <button onclick="zoomImage(1.2)" style="padding:6px 12px;">üîç+ Zoom In</button>
          <button onclick="zoomImage(0.8)" style="padding:6px 12px;">üîç- Zoom Out</button>
          <button onclick="resetImage()" style="padding:6px 12px;">Reset</button>
        </div>
        <div id="image-container" style="flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:auto;border-radius:5px;position:relative;">
          <div style="color:#666;text-align:center;">No image loaded<br><small>Select an image file above</small></div>
        </div>
      </div>
    `
  },
  'advanced-editor': {
    title: 'Advanced Text Editor',
    content: `
      <div style="display:flex;flex-direction:column;height:100%;background:#1e1e1e;color:#d4d4d4;">
        <div style="background:#2d2d2d;padding:8px;border-bottom:1px solid #3e3e3e;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button onclick="editorNew()" style="padding:4px 10px;">New</button>
          <button onclick="editorSave()" style="padding:4px 10px;">Save</button>
          <button onclick="editorLoad()" style="padding:4px 10px;">Load</button>
          <div style="border-left:1px solid #555;height:20px;"></div>
          <select id="editor-lang" onchange="updateEditorHighlight()" style="padding:4px;">
            <option value="javascript">JavaScript</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="python">Python</option>
            <option value="text">Plain Text</option>
          </select>
          <label><input type="checkbox" id="editor-wrap" onchange="toggleWrap()"> Word Wrap</label>
          <span id="editor-stats" style="margin-left:auto;font-size:11px;color:#999;">Lines: 1 | Words: 0 | Chars: 0</span>
        </div>
        <div style="flex:1;position:relative;overflow:hidden;">
          <div id="editor-line-numbers" style="position:absolute;left:0;top:0;bottom:0;width:40px;background:#1e1e1e;border-right:1px solid #3e3e3e;padding:10px 5px;font-family:Consolas,monospace;font-size:13px;color:#858585;overflow:hidden;user-select:none;">1</div>
          <textarea id="advanced-editor-text" oninput="updateEditorStats()" style="position:absolute;left:40px;right:0;top:0;bottom:0;border:none;padding:10px;font-family:Consolas,monospace;font-size:13px;resize:none;outline:none;background:#1e1e1e;color:#d4d4d4;white-space:pre;overflow-wrap:normal;" spellcheck="false"></textarea>
        </div>
      </div>
    `
  },
  'scientific-calc': {
    title: 'Scientific Calculator',
    content: `
      <div style="background:#2c3e50;padding:15px;width:350px;">
        <input type="text" id="sci-calc-display" readonly style="width:100%;height:50px;font-size:24px;text-align:right;margin-bottom:10px;border:2px inset;background:#ecf0f1;padding:5px;box-sizing:border-box;">
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:4px;">
          <button onclick="sciCalcClick('sin')" style="padding:10px;font-size:14px;background:#3498db;color:#fff;">sin</button>
          <button onclick="sciCalcClick('cos')" style="padding:10px;font-size:14px;background:#3498db;color:#fff;">cos</button>
          <button onclick="sciCalcClick('tan')" style="padding:10px;font-size:14px;background:#3498db;color:#fff;">tan</button>
          <button onclick="sciCalcClick('log')" style="padding:10px;font-size:14px;background:#3498db;color:#fff;">log</button>
          <button onclick="sciCalcClick('ln')" style="padding:10px;font-size:14px;background:#3498db;color:#fff;">ln</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:4px;">
          <button onclick="sciCalcClick('sqrt')" style="padding:10px;font-size:14px;background:#9b59b6;color:#fff;">‚àö</button>
          <button onclick="sciCalcClick('pow')" style="padding:10px;font-size:14px;background:#9b59b6;color:#fff;">x¬≤</button>
          <button onclick="sciCalcClick('(')" style="padding:10px;font-size:14px;background:#95a5a6;color:#fff;">(</button>
          <button onclick="sciCalcClick(')')" style="padding:10px;font-size:14px;background:#95a5a6;color:#fff;">)</button>
          <button onclick="sciCalcClear()" style="padding:10px;font-size:14px;background:#e74c3c;color:#fff;">C</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;">
          <button onclick="sciCalcClick('7')" style="padding:12px;font-size:16px;">7</button>
          <button onclick="sciCalcClick('8')" style="padding:12px;font-size:16px;">8</button>
          <button onclick="sciCalcClick('9')" style="padding:12px;font-size:16px;">9</button>
          <button onclick="sciCalcClick('/')" style="padding:12px;font-size:16px;background:#f39c12;color:#fff;">/</button>
          <button onclick="sciCalcClick('4')" style="padding:12px;font-size:16px;">4</button>
          <button onclick="sciCalcClick('5')" style="padding:12px;font-size:16px;">5</button>
          <button onclick="sciCalcClick('6')" style="padding:12px;font-size:16px;">6</button>
          <button onclick="sciCalcClick('*')" style="padding:12px;font-size:16px;background:#f39c12;color:#fff;">*</button>
          <button onclick="sciCalcClick('1')" style="padding:12px;font-size:16px;">1</button>
          <button onclick="sciCalcClick('2')" style="padding:12px;font-size:16px;">2</button>
          <button onclick="sciCalcClick('3')" style="padding:12px;font-size:16px;">3</button>
          <button onclick="sciCalcClick('-')" style="padding:12px;font-size:16px;background:#f39c12;color:#fff;">-</button>
          <button onclick="sciCalcClick('0')" style="padding:12px;font-size:16px;">0</button>
          <button onclick="sciCalcClick('.')" style="padding:12px;font-size:16px;">.</button>
          <button onclick="sciCalcEquals()" style="padding:12px;font-size:16px;background:#27ae60;color:#fff;">=</button>
          <button onclick="sciCalcClick('+')" style="padding:12px;font-size:16px;background:#f39c12;color:#fff;">+</button>
        </div>
      </div>
    `
  },
  'world-clock': {
    title: 'Clock & Timer',
    content: `
      <div style="background:linear-gradient(to bottom,#667eea,#764ba2);padding:20px;color:#fff;height:100%;">
        <div style="text-align:center;margin-bottom:20px;">
          <h1 id="clock-time" style="font-size:48px;margin:0;">00:00:00</h1>
          <div id="clock-date" style="font-size:18px;margin-top:5px;"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
          <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:8px;">
            <h3 style="margin-top:0;">‚è±Ô∏è Stopwatch</h3>
            <div id="stopwatch-display" style="font-size:32px;text-align:center;margin:15px 0;">00:00:00</div>
            <div style="text-align:center;">
              <button onclick="startStopwatch()" style="padding:8px 15px;margin:2px;">Start</button>
              <button onclick="stopStopwatch()" style="padding:8px 15px;margin:2px;">Stop</button>
              <button onclick="resetStopwatch()" style="padding:8px 15px;margin:2px;">Reset</button>
            </div>
          </div>
          <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:8px;">
            <h3 style="margin-top:0;">‚è≤Ô∏è Timer</h3>
            <input type="number" id="timer-input" placeholder="Seconds" style="width:100%;padding:8px;margin-bottom:10px;box-sizing:border-box;">
            <div id="timer-display" style="font-size:32px;text-align:center;margin:15px 0;">00:00</div>
            <div style="text-align:center;">
              <button onclick="startTimer()" style="padding:8px 15px;margin:2px;">Start</button>
              <button onclick="stopTimer()" style="padding:8px 15px;margin:2px;">Stop</button>
              <button onclick="resetTimer()" style="padding:8px 15px;margin:2px;">Reset</button>
            </div>
          </div>
        </div>
      </div>
    `
  },
  'todo-list': {
    title: 'To-Do List',
    content: `
      <div style="background:#f8f9fa;padding:20px;height:100%;display:flex;flex-direction:column;">
        <h2 style="margin:0 0 15px 0;color:#333;">üìù To-Do List</h2>
        <div style="display:flex;gap:5px;margin-bottom:15px;">
          <input type="text" id="todo-input" placeholder="Add a new task..." style="flex:1;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" onkeydown="if(event.key==='Enter')addTodo()">
          <button onclick="addTodo()" style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Add</button>
        </div>
        <div style="display:flex;gap:5px;margin-bottom:15px;">
          <button onclick="filterTodos('all')" id="filter-all" style="padding:6px 12px;background:#6c757d;color:#fff;border:none;border-radius:4px;cursor:pointer;">All</button>
          <button onclick="filterTodos('active')" id="filter-active" style="padding:6px 12px;background:#f8f9fa;border:1px solid #ddd;border-radius:4px;cursor:pointer;">Active</button>
          <button onclick="filterTodos('completed')" id="filter-completed" style="padding:6px 12px;background:#f8f9fa;border:1px solid #ddd;border-radius:4px;cursor:pointer;">Completed</button>
          <button onclick="clearCompleted()" style="padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-left:auto;">Clear Completed</button>
        </div>
        <div id="todo-list" style="flex:1;overflow-y:auto;background:#fff;border:1px solid #ddd;border-radius:4px;padding:10px;">
          <div style="color:#999;text-align:center;padding:40px 20px;">No tasks yet. Add one above!</div>
        </div>
        <div style="margin-top:10px;text-align:center;color:#666;font-size:13px;">
          <span id="todo-count">0 tasks</span>
        </div>
      </div>
    `
  }
};

let windowZIndex = 1000;
let defaultWindowWidth = 800;
let defaultWindowHeight = 600;
let activeWindow = null;
let use24Hour = true;

function createWindow(app, width = defaultWindowWidth, height = defaultWindowHeight){
  const {title,content}=apps[app];
  const window=document.createElement('div');
  window.className='window';
  window.style.top='50px';
  window.style.left='50px';
  window.style.width=width+'px';
  window.style.height=height+'px';
  window.style.zIndex = ++windowZIndex;
  window.innerHTML=`
    <div class="window-header">
      <span>${title}</span>
      <div>
        <span class="minimize-btn">_</span>
        <span class="maximize-btn">‚ñ°</span>
        <span class="close-btn">‚úñ</span>
      </div>
    </div>
    <div class="window-content">${content}</div>
  `;
  document.getElementById('desktop').appendChild(window);
activeWindow = window;
  window.addEventListener("mousedown", ()=>{ activeWindow = window; });
  playOpenSound();

  if(app === 'psp-emu' || app === 'google-chrome'){
    window.classList.add('maximized');
  }

  let isDragging=false;
  let startX,startY,startLeft,startTop;

  const header = window.querySelector('.window-header');

  // Double-click to maximize
  header.addEventListener('dblclick', function(){
    if(app !== 'psp-emu' && app !== 'google-chrome'){
      window.classList.toggle('maximized');
    }
  });

  header.addEventListener('mousedown',function(e){
    if(app !== 'psp-emu' && app !== 'google-chrome'){
      isDragging=true;
      startX=e.clientX;
      startY=e.clientY;
      startLeft=parseInt(window.style.left)||0;
      startTop=parseInt(window.style.top)||0;
      window.style.zIndex = ++windowZIndex;
    }
  });

  document.addEventListener('mousemove',function(e){
    if(!isDragging)return;
    const newLeft=startLeft+e.clientX-startX;
    const newTop=startTop+e.clientY-startY;
    window.style.left=newLeft+'px';
    window.style.top=newTop+'px';
  });

  document.addEventListener('mouseup',function(){
    isDragging=false;
  });

  window.querySelector('.close-btn').addEventListener('click',function(){
    playCloseSound();
    window.remove();
    removeTaskbarItem(window);
  });

  window.querySelector('.minimize-btn').addEventListener('click',function(){
    window.classList.add('minimized');
    updateTaskbarItem(window);
  });

  window.querySelector('.maximize-btn').addEventListener('click',function(){
    window.classList.toggle('maximized');
  });

  addTaskbarItem(window);

  // Initialize specific apps after window is created
  setTimeout(() => {
    if(app === 'file-explorer') {
      explorerNavigate(explorerCurrentPath, false);
    } else if(app === 'recycle-bin') {
      recycleBinRefresh();
    } else if(app === 'cmd') {
      const prompt = window.querySelector('#cmd-prompt');
      if(prompt) prompt.textContent = cmdCurrentPath + '>';
    } else if(app === 'paint') {
      initPaint();
    } else if(app === 'minesweeper') {
      initMinesweeper();
    } else if(app === 'solitaire') {
      initSolitaire();
    } else if(app === 'tictactoe') {
      initTicTacToe();
    } else if(app === 'snake') {
      initSnake();
    } else if(app === 'pong') {
      initPong();
    } else if(app === 'breakout') {
      initBreakout();
    } else if(app === 'game-2048') {
      init2048();
    }
  }, 100);

  return window;
}

function addTaskbarItem(window){
  const taskbarItems = document.getElementById('taskbar-items');
  const item = document.createElement('div');
  item.className = 'taskbar-item';
  item.textContent = window.querySelector('.window-header span').textContent;
  item.addEventListener('click', function(){
    if(window.classList.contains('minimized')){
      window.classList.remove('minimized');
      window.style.zIndex = ++windowZIndex;
    } else {
      window.classList.add('minimized');
    }
    updateTaskbarItem(window);
  });
  taskbarItems.appendChild(item);
  window.taskbarItem = item;
}

function updateTaskbarItem(window){
  if(window.classList.contains('minimized')){
    window.taskbarItem.style.background = 'linear-gradient(to bottom, #d0d0d0, #c0c0c0)';
  } else {
    window.taskbarItem.style.background = 'linear-gradient(to bottom, #f0f0f0, #e0e0e0)';
  }
}

function removeTaskbarItem(window){
  if(window.taskbarItem){
    window.taskbarItem.remove();
  }
}


function attachIcon(icon){
  let isDragging = false;
  let startX, startY;
  icon.addEventListener('mousedown', function(e){
    isDragging = true;
    startX = e.clientX - icon.offsetLeft;
    startY = e.clientY - icon.offsetTop;
    icon.style.zIndex = ++windowZIndex;
  });
  document.addEventListener('mousemove', function(e){
    if(!isDragging) return;
    let newX = e.clientX - startX;
    let newY = e.clientY - startY;
    icon.style.left = newX + 'px';
    icon.style.top = newY + 'px';
  });
  document.addEventListener('mouseup', function(){
    isDragging = false;
  });
  icon.addEventListener('click', function(e){
    if(!isDragging){
      const app = this.dataset.app;
      createWindow(app);
    }
  });
  icon.addEventListener('contextmenu', function(e){
    e.preventDefault();
    const url = prompt('Enter new icon URL:', this.querySelector('img').src);
    if(url){
      this.querySelector('img').src = url;
    }
  });
}

document.querySelectorAll('.icon').forEach(attachIcon);
document.querySelectorAll('.start-menu-item').forEach(item => {
  item.addEventListener('click', function() {
    const app = this.dataset.app;
    if (app === 'log-off' || app === 'turn-off') {
      alert(`You clicked on ${this.textContent}. This action is not implemented in this simulation.`);
    } else {
      createWindow(app);
    }
    document.querySelector('.start-menu').style.display = 'none';
  });
});

const startButton=document.querySelector('.start-button');const addAppButton=document.querySelector('.add-app-button');
const startMenu=document.querySelector('.start-menu');

startButton.addEventListener('click',function(){
  if(startMenu.style.display === 'block'){
    startMenu.style.display='none';
  }else{
    startMenu.style.display='block';
  }
});

document.addEventListener('click',function(e){
  if(!startButton.contains(e.target) && !startMenu.contains(e.target)){
    startMenu.style.display='none';
  }
});

addAppButton.addEventListener('click',function(){
  const id=prompt('Enter app ID (unique key):');
  if(!id || apps[id]) return;
  const title=prompt('Enter app title:');
  if(!title) return;
  const content=prompt('Enter HTML content for the app:','<div style="padding:20px">New App</div>');
  if(content===null) return;
  const iconUrl=prompt('Enter icon URL:','https://cdn-icons-png.flaticon.com/512/888/888879.png');
  if(iconUrl===null) return;
  apps[id]={title,content};
  const icon=document.createElement('div');
  icon.className='icon';
  icon.dataset.app=id;
  icon.style.top='20px';
  icon.style.left=(20+document.querySelectorAll(".icon").length*80)+'px';
  icon.innerHTML=`<img src="${iconUrl}" alt="${title}"><div class="icon-label">${title}</div>`;
  document.getElementById('desktop').appendChild(icon);
  attachIcon(icon);
});
function updateClock(){
  const now = new Date();
  const israelTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
  let h = israelTime.getHours();
  const minutes = israelTime.getMinutes().toString().padStart(2, '0');
  let displayHours = h.toString().padStart(2, '0');
  let suffix = '';
  if(!use24Hour){
    displayHours = ((h % 12) || 12).toString().padStart(2, '0');
    suffix = h >= 12 ? ' PM' : ' AM';
  }
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const dayName = days[israelTime.getDay()];
  const date = israelTime.getDate().toString().padStart(2, '0');
  const month = (israelTime.getMonth() + 1).toString().padStart(2, '0');
  document.querySelector('.clock').textContent = `${displayHours}:${minutes}${suffix}`;
  document.querySelector('.clock').title = `${dayName}, ${date}/${month}/${israelTime.getFullYear()}`;
}
setInterval(updateClock,1000);
updateClock();

// Calculator functions
let calcMemory = 0;

function calcClick(val){
  const display = document.getElementById('calc-display');
  if(display) display.value += val;
}

function calcEquals(){
  const display = document.getElementById('calc-display');
  if(display){
    try{
      display.value = eval(display.value);
    }catch(e){
      display.value = 'Error';
    }
  }
}

function calcClear(){
  const display = document.getElementById('calc-display');
  if(display) display.value = '';
}

function calcBackspace(){
  const display = document.getElementById('calc-display');
  if(display) display.value = display.value.slice(0, -1);
}

function calcMemoryAdd(){
  const display = document.getElementById('calc-display');
  const memDisplay = document.getElementById('calc-memory');
  if(display && display.value){
    try{
      const val = eval(display.value);
      calcMemory += val;
      if(memDisplay) memDisplay.textContent = calcMemory;
      playClickSound();
    }catch(e){}
  }
}

function calcMemorySub(){
  const display = document.getElementById('calc-display');
  const memDisplay = document.getElementById('calc-memory');
  if(display && display.value){
    try{
      const val = eval(display.value);
      calcMemory -= val;
      if(memDisplay) memDisplay.textContent = calcMemory;
      playClickSound();
    }catch(e){}
  }
}

function calcMemoryRecall(){
  const display = document.getElementById('calc-display');
  if(display){
    display.value = calcMemory;
    playClickSound();
  }
}

function calcMemoryClear(){
  calcMemory = 0;
  const memDisplay = document.getElementById('calc-memory');
  if(memDisplay) memDisplay.textContent = '0';
  playClickSound();
}

// Notepad functions
function saveNotepad(){
  const text = document.querySelector('.notepad-text');
  if(!text) return;

  // Check if file is already loaded
  if(text.dataset.filepath && text.dataset.filename){
    // Save to existing file
    if(vfs.writeFile(text.dataset.filepath, text.dataset.filename, text.value)){
      showNotification('Notepad', `Saved: ${text.dataset.filename}`);
    } else {
      alert('Failed to save file.');
    }
  } else {
    // Save As - create new file
    const filename = prompt('Enter file name (with .txt extension):', 'Untitled.txt');
    if(!filename) return;

    const path = prompt('Enter path (e.g., C:\\My Documents):', 'C:\\My Documents');
    if(!path) return;

    if(vfs.createFile(path, filename, text.value)){
      text.dataset.filepath = path;
      text.dataset.filename = filename;
      showNotification('Notepad', `Saved: ${filename}`);
    } else {
      alert('Failed to save file. Path may not exist or file already exists.');
    }
  }
}

function loadNotepad(){
  const text = document.querySelector('.notepad-text');
  if(!text) return;

  const path = prompt('Enter path (e.g., C:\\My Documents):', 'C:\\My Documents');
  if(!path) return;

  const filename = prompt('Enter file name:');
  if(!filename) return;

  const file = vfs.readFile(path, filename);
  if(file){
    text.value = file.content;
    text.dataset.filepath = path;
    text.dataset.filename = filename;
    showNotification('Notepad', `Loaded: ${filename}`);
  } else {
    alert('File not found.');
  }
}

function searchNotepad(){
  const text = document.querySelector('.notepad-text');
  const searchInput = document.getElementById('notepad-search');
  if(text && searchInput && searchInput.value){
    const searchTerm = searchInput.value;
    const content = text.value;
    const index = content.toLowerCase().indexOf(searchTerm.toLowerCase());

    if(index !== -1){
      text.focus();
      text.setSelectionRange(index, index + searchTerm.length);
      text.scrollTop = text.scrollHeight * (index / content.length);
      playClickSound();
    }else{
      alert('Text not found: ' + searchTerm);
      playErrorSound();
    }
  }
}

function countWords(){
  const text = document.querySelector('.notepad-text');
  if(text){
    const content = text.value.trim();
    const words = content ? content.split(/\s+/).length : 0;
    const chars = content.length;
    const lines = content ? content.split('\n').length : 0;
    alert(`Words: ${words}\nCharacters: ${chars}\nLines: ${lines}`);
    playClickSound();
  }
}

function updateNotepadStats(){
  const text = document.querySelector('.notepad-text');
  const stats = document.getElementById('notepad-stats');
  if(text && stats){
    const content = text.value.trim();
    const words = content ? content.split(/\s+/).length : 0;
    const chars = text.value.length;
    stats.textContent = `Words: ${words} | Chars: ${chars}`;
  }
}

// Paint functions
let painting = false;
let paintCanvas, paintCtx;
let paintTool = 'brush';
let paintStartX, paintStartY;
let paintSnapshot;

function setPaintTool(tool){
  paintTool = tool;
  // Update button styles
  ['brush', 'rectangle', 'circle', 'eraser'].forEach(t => {
    const btn = document.getElementById('tool-' + t);
    if(btn){
      btn.style.border = t === tool ? '2px inset #999' : '2px outset #999';
      btn.style.background = t === tool ? '#fff' : '';
    }
  });
}

function initPaint(){
  paintCanvas = document.getElementById('paint-canvas');
  if(!paintCanvas) return;
  paintCanvas.width = paintCanvas.offsetWidth;
  paintCanvas.height = paintCanvas.offsetHeight;
  paintCtx = paintCanvas.getContext('2d');
  paintCtx.lineCap = 'round';

  paintCanvas.addEventListener('mousedown', e => {
    painting = true;
    const rect = paintCanvas.getBoundingClientRect();
    paintStartX = e.clientX - rect.left;
    paintStartY = e.clientY - rect.top;

    if(paintTool === 'brush' || paintTool === 'eraser'){
      paintCtx.beginPath();
      paintCtx.moveTo(paintStartX, paintStartY);
    }else{
      // Save canvas state for shape tools
      paintSnapshot = paintCtx.getImageData(0, 0, paintCanvas.width, paintCanvas.height);
    }
  });

  paintCanvas.addEventListener('mousemove', e => {
    if(!painting) return;
    const rect = paintCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const color = document.getElementById('paint-color');
    const size = document.getElementById('paint-size');

    if(paintTool === 'brush'){
      paintCtx.strokeStyle = color ? color.value : '#000';
      paintCtx.lineWidth = size ? size.value : 3;
      paintCtx.lineTo(x, y);
      paintCtx.stroke();
    }else if(paintTool === 'eraser'){
      paintCtx.strokeStyle = '#fff';
      paintCtx.lineWidth = size ? parseInt(size.value) * 3 : 9;
      paintCtx.lineTo(x, y);
      paintCtx.stroke();
    }else if(paintTool === 'rectangle'){
      // Restore canvas and draw preview
      paintCtx.putImageData(paintSnapshot, 0, 0);
      paintCtx.strokeStyle = color ? color.value : '#000';
      paintCtx.lineWidth = size ? size.value : 3;
      paintCtx.strokeRect(paintStartX, paintStartY, x - paintStartX, y - paintStartY);
    }else if(paintTool === 'circle'){
      // Restore canvas and draw preview
      paintCtx.putImageData(paintSnapshot, 0, 0);
      paintCtx.strokeStyle = color ? color.value : '#000';
      paintCtx.lineWidth = size ? size.value : 3;
      const radius = Math.sqrt(Math.pow(x - paintStartX, 2) + Math.pow(y - paintStartY, 2));
      paintCtx.beginPath();
      paintCtx.arc(paintStartX, paintStartY, radius, 0, 2 * Math.PI);
      paintCtx.stroke();
    }
  });

  paintCanvas.addEventListener('mouseup', () => painting = false);
  paintCanvas.addEventListener('mouseleave', () => painting = false);
}

function clearCanvas(){
  if(paintCtx && paintCanvas){
    paintCtx.clearRect(0, 0, paintCanvas.width, paintCanvas.height);
  }
}

function fillCanvas(){
  if(paintCtx && paintCanvas){
    const color = document.getElementById('paint-color');
    paintCtx.fillStyle = color ? color.value : '#fff';
    paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
  }
}

// Minesweeper functions
let mineGrid = [];
let mineRows = 9;
let mineCols = 9;
let mineCount = 10;
function initMinesweeper(){
  const grid = document.getElementById('minesweeper-grid');
  if(!grid) return;
  grid.innerHTML = '';
  mineGrid = [];

  // Create grid
  for(let i = 0; i < mineRows; i++){
    mineGrid[i] = [];
    for(let j = 0; j < mineCols; j++){
      mineGrid[i][j] = {mine: false, revealed: false, flagged: false, adjacent: 0};
    }
  }

  // Place mines
  let placed = 0;
  while(placed < mineCount){
    const r = Math.floor(Math.random() * mineRows);
    const c = Math.floor(Math.random() * mineCols);
    if(!mineGrid[r][c].mine){
      mineGrid[r][c].mine = true;
      placed++;
    }
  }

  // Calculate adjacent mines
  for(let i = 0; i < mineRows; i++){
    for(let j = 0; j < mineCols; j++){
      if(mineGrid[i][j].mine) continue;
      let count = 0;
      for(let di = -1; di <= 1; di++){
        for(let dj = -1; dj <= 1; dj++){
          const ni = i + di;
          const nj = j + dj;
          if(ni >= 0 && ni < mineRows && nj >= 0 && nj < mineCols && mineGrid[ni][nj].mine){
            count++;
          }
        }
      }
      mineGrid[i][j].adjacent = count;
    }
  }

  // Render grid
  const table = document.createElement('table');
  table.style.borderCollapse = 'collapse';
  for(let i = 0; i < mineRows; i++){
    const tr = document.createElement('tr');
    for(let j = 0; j < mineCols; j++){
      const td = document.createElement('td');
      td.style.width = '25px';
      td.style.height = '25px';
      td.style.border = '1px solid #999';
      td.style.textAlign = 'center';
      td.style.cursor = 'pointer';
      td.style.background = '#c0c0c0';
      td.style.fontWeight = 'bold';
      td.dataset.row = i;
      td.dataset.col = j;
      td.addEventListener('click', () => revealCell(i, j));
      td.addEventListener('contextmenu', e => {
        e.preventDefault();
        toggleFlag(i, j);
      });
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  grid.appendChild(table);
}
function revealCell(r, c){
  if(mineGrid[r][c].revealed || mineGrid[r][c].flagged) return;
  mineGrid[r][c].revealed = true;
  const grid = document.getElementById('minesweeper-grid');
  const cell = grid.querySelector(`td[data-row="${r}"][data-col="${c}"]`);
  if(!cell) return;

  if(mineGrid[r][c].mine){
    cell.textContent = 'üí£';
    cell.style.background = '#f00';
    setTimeout(() => {
      alert('Game Over! You hit a mine!');
      initMinesweeper();
    }, 100);
  }else{
    cell.style.background = '#fff';
    if(mineGrid[r][c].adjacent > 0){
      cell.textContent = mineGrid[r][c].adjacent;
      const colors = ['', '#0000ff', '#008000', '#ff0000', '#000080', '#800000', '#008080', '#000', '#808080'];
      cell.style.color = colors[mineGrid[r][c].adjacent];
    }else{
      // Reveal adjacent cells
      for(let di = -1; di <= 1; di++){
        for(let dj = -1; dj <= 1; dj++){
          const ni = r + di;
          const nj = c + dj;
          if(ni >= 0 && ni < mineRows && nj >= 0 && nj < mineCols){
            revealCell(ni, nj);
          }
        }
      }
    }
  }
}
function toggleFlag(r, c){
  if(mineGrid[r][c].revealed) return;
  mineGrid[r][c].flagged = !mineGrid[r][c].flagged;
  const grid = document.getElementById('minesweeper-grid');
  const cell = grid.querySelector(`td[data-row="${r}"][data-col="${c}"]`);
  if(cell){
    cell.textContent = mineGrid[r][c].flagged ? 'üö©' : '';
  }
}

// Media Player function
function loadMedia(){
  const url = document.getElementById('media-url');
  const container = document.getElementById('media-container');
  if(url && container && url.value){
    if(url.value.includes('youtube.com') || url.value.includes('youtu.be')){
      let videoId = '';
      if(url.value.includes('watch?v=')){
        videoId = url.value.split('watch?v=')[1].split('&')[0];
      }else if(url.value.includes('youtu.be/')){
        videoId = url.value.split('youtu.be/')[1].split('?')[0];
      }
      if(videoId){
        container.innerHTML = `<iframe width="100%" height="300" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
      }
    }else{
      container.innerHTML = `<video width="100%" height="300" controls><source src="${url.value}">Your browser does not support video.</video>`;
    }
  }
}

// Snake Game functions
let snakeGame = null;

function initSnake(){
  const canvas = document.getElementById('snake-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  // Draw initial empty grid
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Draw grid lines
  ctx.strokeStyle = '#0f0';
  ctx.globalAlpha = 0.1;
  const gridSize = 20;
  for(let i = 0; i < canvas.width; i += gridSize){
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, canvas.height);
    ctx.stroke();
  }
  for(let i = 0; i < canvas.height; i += gridSize){
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(canvas.width, i);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // Draw "Press Start" message
  ctx.fillStyle = '#0f0';
  ctx.font = '24px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Press START to begin!', canvas.width / 2, canvas.height / 2);

  // Load high score
  const highScore = localStorage.getItem('snake-high') || 0;
  document.getElementById('snake-high').textContent = highScore;
  document.getElementById('snake-score').textContent = '0';
}

function startSnake(){
  const canvas = document.getElementById('snake-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const gridSize = 20;
  const tileCount = canvas.width / gridSize;

  if(snakeGame) clearInterval(snakeGame);

  let snake = [{x: 10, y: 10}];
  let food = {x: 15, y: 15};
  let dx = 0, dy = 0;
  let score = 0;
  let paused = false;

  document.getElementById('snake-score').textContent = score;
  const highScore = localStorage.getItem('snake-high') || 0;
  document.getElementById('snake-high').textContent = highScore;

  document.addEventListener('keydown', e => {
    if(e.key === 'ArrowUp' && dy === 0) { dx = 0; dy = -1; }
    if(e.key === 'ArrowDown' && dy === 0) { dx = 0; dy = 1; }
    if(e.key === 'ArrowLeft' && dx === 0) { dx = -1; dy = 0; }
    if(e.key === 'ArrowRight' && dx === 0) { dx = 1; dy = 0; }
  });

  snakeGame = setInterval(() => {
    if(paused) return;

    const head = {x: snake[0].x + dx, y: snake[0].y + dy};

    if(head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount || snake.some(s => s.x === head.x && s.y === head.y)){
      clearInterval(snakeGame);
      playErrorSound();
      alert('Game Over! Score: ' + score);
      if(score > highScore) localStorage.setItem('snake-high', score);
      return;
    }

    snake.unshift(head);

    if(head.x === food.x && head.y === food.y){
      score += 10;
      document.getElementById('snake-score').textContent = score;
      playClickSound();
      food = {x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount)};
    }else{
      snake.pop();
    }

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = '#0f0';
    snake.forEach(s => ctx.fillRect(s.x * gridSize, s.y * gridSize, gridSize - 2, gridSize - 2));

    ctx.fillStyle = '#f00';
    ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
  }, 150);
}
function pauseSnake(){
  if(snakeGame) clearInterval(snakeGame);
}

// Tic-Tac-Toe functions
let tttBoard = ['', '', '', '', '', '', '', '', ''];
let tttPlayer = 'X';
let tttGameOver = false;
function initTicTacToe(){
  tttBoard = ['', '', '', '', '', '', '', '', ''];
  tttPlayer = 'X';
  tttGameOver = false;
  const board = document.getElementById('ttt-board');
  if(!board) return;
  board.innerHTML = '';
  for(let i = 0; i < 9; i++){
    const cell = document.createElement('div');
    cell.style.width = '80px';
    cell.style.height = '80px';
    cell.style.background = '#fff';
    cell.style.border = '2px solid #333';
    cell.style.display = 'flex';
    cell.style.alignItems = 'center';
    cell.style.justifyContent = 'center';
    cell.style.fontSize = '48px';
    cell.style.fontWeight = 'bold';
    cell.style.cursor = 'pointer';
    cell.dataset.index = i;
    cell.addEventListener('click', () => tttMove(i));
    board.appendChild(cell);
  }
  document.getElementById('ttt-player').textContent = tttPlayer;
  document.getElementById('ttt-status').textContent = '';
}
function tttMove(index){
  if(tttGameOver || tttBoard[index]) return;
  tttBoard[index] = tttPlayer;
  const board = document.getElementById('ttt-board');
  const cell = board.children[index];
  cell.textContent = tttPlayer;
  cell.style.color = tttPlayer === 'X' ? '#00f' : '#f00';
  playClickSound();

  if(tttCheckWin()){
    document.getElementById('ttt-status').textContent = `Player ${tttPlayer} wins!`;
    tttGameOver = true;
    return;
  }

  if(tttBoard.every(c => c)){
    document.getElementById('ttt-status').textContent = 'Draw!';
    tttGameOver = true;
    return;
  }

  tttPlayer = tttPlayer === 'X' ? 'O' : 'X';
  document.getElementById('ttt-player').textContent = tttPlayer;
}
function tttCheckWin(){
  const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return wins.some(w => tttBoard[w[0]] && tttBoard[w[0]] === tttBoard[w[1]] && tttBoard[w[0]] === tttBoard[w[2]]);
}
function resetTicTacToe(){
  initTicTacToe();
}

// Task Manager functions
function refreshTaskManager(){
  const tbody = document.getElementById('task-tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const windows = document.querySelectorAll('.window');
  windows.forEach(win => {
    const title = win.querySelector('.window-header span').textContent;
    const status = win.classList.contains('minimized') ? 'Minimized' : 'Running';
    const row = tbody.insertRow();
    row.innerHTML = `
      <td style="padding:5px;border:1px solid #999;">${title}</td>
      <td style="padding:5px;border:1px solid #999;">${status}</td>
      <td style="padding:5px;border:1px solid #999;">
        <button onclick="this.closest('tr').taskWindow.remove(); refreshTaskManager();" style="padding:2px 8px;">Close</button>
      </td>
    `;
    row.taskWindow = win;
  });
}
function closeAllWindows(){
  if(confirm('Close all windows?')){
    document.querySelectorAll('.window').forEach(w => w.remove());
    refreshTaskManager();
  }
}

// Sticky Notes functions
function saveStickyNote(){
  const text = document.getElementById('sticky-text');
  if(text){
    localStorage.setItem('sticky-note', text.value);
    alert('Note saved!');
  }
}
function loadStickyNote(){
  const text = document.getElementById('sticky-text');
  if(text){
    const saved = localStorage.getItem('sticky-note');
    if(saved) text.value = saved;
  }
}
function clearStickyNote(){
  const text = document.getElementById('sticky-text');
  if(text) text.value = '';
}

// Calendar functions
let calendarDate = new Date();
function initCalendar(){
  updateCalendarDisplay();
}
function updateCalendarDisplay(){
  const monthEl = document.getElementById('calendar-month');
  const gridEl = document.getElementById('calendar-grid');
  if(!monthEl || !gridEl) return;

  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  monthEl.textContent = `${months[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;

  gridEl.innerHTML = '';
  const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
  days.forEach(d => {
    const dayHeader = document.createElement('div');
    dayHeader.textContent = d;
    dayHeader.style.fontWeight = 'bold';
    dayHeader.style.padding = '5px';
    gridEl.appendChild(dayHeader);
  });

  const firstDay = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1).getDay();
  const daysInMonth = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0).getDate();

  for(let i = 0; i < firstDay; i++){
    gridEl.appendChild(document.createElement('div'));
  }

  const today = new Date();
  for(let day = 1; day <= daysInMonth; day++){
    const dayEl = document.createElement('div');
    dayEl.textContent = day;
    dayEl.style.padding = '5px';
    dayEl.style.textAlign = 'center';
    dayEl.style.cursor = 'pointer';
    dayEl.style.background = '#fff';
    dayEl.style.border = '1px solid #ccc';

    if(day === today.getDate() && calendarDate.getMonth() === today.getMonth() && calendarDate.getFullYear() === today.getFullYear()){
      dayEl.style.background = '#316AC5';
      dayEl.style.color = '#fff';
      dayEl.style.fontWeight = 'bold';
    }

    dayEl.addEventListener('click', () => alert(`Selected: ${months[calendarDate.getMonth()]} ${day}, ${calendarDate.getFullYear()}`));
    gridEl.appendChild(dayEl);
  }
}
function calendarPrevMonth(){
  calendarDate.setMonth(calendarDate.getMonth() - 1);
  updateCalendarDisplay();
}
function calendarNextMonth(){
  calendarDate.setMonth(calendarDate.getMonth() + 1);
  updateCalendarDisplay();
}
function calendarToday(){
  calendarDate = new Date();
  updateCalendarDisplay();
}

// Photo Viewer functions
function loadPhoto(){
  const url = document.getElementById('photo-url');
  const container = document.getElementById('photo-container');
  if(url && container && url.value){
    container.innerHTML = `<img src="${url.value}" style="max-width:100%;max-height:100%;object-fit:contain;" onerror="this.parentElement.innerHTML='<div style=color:#f00>Failed to load image</div>'">`;
  }
}

// Solitaire functions
let solitaireState = {
  deck: [],
  stock: [],
  waste: [],
  foundations: [[],[],[],[]],
  tableau: [[],[],[],[],[],[],[]],
  draggedCard: null,
  draggedFrom: null
};

function initSolitaire(){
  const game = document.getElementById('solitaire-game');
  if(!game) return;

  // Create deck
  const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
  const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const colors = {'‚ô†':'black','‚ô£':'black','‚ô•':'red','‚ô¶':'red'};

  solitaireState.deck = [];
  for(let suit of suits){
    for(let i = 0; i < values.length; i++){
      solitaireState.deck.push({suit, value: values[i], numValue: i+1, color: colors[suit]});
    }
  }

  // Shuffle deck
  for(let i = solitaireState.deck.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [solitaireState.deck[i], solitaireState.deck[j]] = [solitaireState.deck[j], solitaireState.deck[i]];
  }

  // Deal cards
  solitaireState.tableau = [[],[],[],[],[],[],[]];
  solitaireState.foundations = [[],[],[],[]];
  solitaireState.waste = [];

  for(let i = 0; i < 7; i++){
    for(let j = i; j < 7; j++){
      const card = solitaireState.deck.pop();
      card.faceUp = (i === j);
      solitaireState.tableau[j].push(card);
    }
  }

  solitaireState.stock = solitaireState.deck;

  renderSolitaire();
}

function renderSolitaire(){
  const game = document.getElementById('solitaire-game');
  if(!game) return;

  let html = '<div style="display:flex;gap:10px;margin-bottom:20px;">';

  // Stock pile
  html += `<div style="width:70px;height:95px;border:2px solid #fff;border-radius:5px;background:${solitaireState.stock.length > 0 ? '#00f' : 'rgba(255,255,255,0.1)'};cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;" onclick="drawCard()">
    ${solitaireState.stock.length > 0 ? 'üÇ†' : ''}
  </div>`;

  // Waste pile
  const wasteCard = solitaireState.waste.length > 0 ? solitaireState.waste[solitaireState.waste.length - 1] : null;
  html += `<div style="width:70px;height:95px;border:2px solid #fff;border-radius:5px;background:${wasteCard ? '#fff' : 'rgba(255,255,255,0.1)'};display:flex;align-items:center;justify-content:center;color:${wasteCard ? wasteCard.color : '#fff'};font-size:18px;font-weight:bold;" ${wasteCard ? `draggable="true" ondragstart="solDragStart('waste', ${solitaireState.waste.length - 1})"` : ''}>
    ${wasteCard ? wasteCard.value + wasteCard.suit : ''}
  </div>`;

  html += '<div style="flex:1;"></div>';

  // Foundation piles
  for(let i = 0; i < 4; i++){
    const topCard = solitaireState.foundations[i].length > 0 ? solitaireState.foundations[i][solitaireState.foundations[i].length - 1] : null;
    html += `<div style="width:70px;height:95px;border:2px solid #fff;border-radius:5px;background:${topCard ? '#fff' : 'rgba(255,255,255,0.2)'};display:flex;align-items:center;justify-content:center;color:${topCard ? topCard.color : '#fff'};font-size:18px;font-weight:bold;" ondrop="solDrop('foundation', ${i})" ondragover="event.preventDefault()">
      ${topCard ? topCard.value + topCard.suit : (i === 0 ? '‚ô†' : i === 1 ? '‚ô•' : i === 2 ? '‚ô¶' : '‚ô£')}
    </div>`;
  }

  html += '</div>';

  // Tableau
  html += '<div style="display:flex;gap:10px;">';
  for(let i = 0; i < 7; i++){
    html += `<div style="width:70px;min-height:95px;border:2px dashed rgba(255,255,255,0.3);border-radius:5px;position:relative;" ondrop="solDrop('tableau', ${i})" ondragover="event.preventDefault()">`;

    for(let j = 0; j < solitaireState.tableau[i].length; j++){
      const card = solitaireState.tableau[i][j];
      const offsetTop = j * 25;
      if(card.faceUp){
        html += `<div style="position:absolute;top:${offsetTop}px;width:66px;height:91px;border:1px solid #000;border-radius:5px;background:#fff;display:flex;align-items:center;justify-content:center;color:${card.color};font-size:18px;font-weight:bold;cursor:move;" draggable="true" ondragstart="solDragStart('tableau', ${i}, ${j})">
          ${card.value}${card.suit}
        </div>`;
      }else{
        html += `<div style="position:absolute;top:${offsetTop}px;width:66px;height:91px;border:1px solid #000;border-radius:5px;background:#00f;cursor:default;" onclick="flipTableauCard(${i})">
          üÇ†
        </div>`;
      }
    }

    html += '</div>';
  }
  html += '</div>';

  game.innerHTML = html;

  checkWin();
}

function drawCard(){
  if(solitaireState.stock.length > 0){
    const card = solitaireState.stock.pop();
    card.faceUp = true;
    solitaireState.waste.push(card);
    playClickSound();
  }else if(solitaireState.waste.length > 0){
    // Reset stock from waste
    solitaireState.stock = solitaireState.waste.reverse();
    solitaireState.waste = [];
    solitaireState.stock.forEach(c => c.faceUp = false);
    playClickSound();
  }
  renderSolitaire();
}

function solDragStart(from, pile, index = -1){
  event.dataTransfer.effectAllowed = 'move';
  solitaireState.draggedFrom = {from, pile, index};
}

function solDrop(to, pile){
  event.preventDefault();
  if(!solitaireState.draggedFrom) return;

  const {from, pile: fromPile, index} = solitaireState.draggedFrom;
  let card, cards = [];

  if(from === 'waste'){
    card = solitaireState.waste[solitaireState.waste.length - 1];
    cards = [card];
  }else if(from === 'tableau'){
    card = solitaireState.tableau[fromPile][index];
    cards = solitaireState.tableau[fromPile].slice(index);
  }

  // Validate move
  let valid = false;

  if(to === 'foundation'){
    if(cards.length === 1){
      const foundation = solitaireState.foundations[pile];
      if(foundation.length === 0){
        valid = card.value === 'A';
      }else{
        const topCard = foundation[foundation.length - 1];
        valid = card.suit === topCard.suit && card.numValue === topCard.numValue + 1;
      }
    }
  }else if(to === 'tableau'){
    const tableau = solitaireState.tableau[pile];
    if(tableau.length === 0){
      valid = card.value === 'K';
    }else{
      const topCard = tableau[tableau.length - 1];
      if(topCard.faceUp){
        valid = card.color !== topCard.color && card.numValue === topCard.numValue - 1;
      }
    }
  }

  if(valid){
    // Move cards
    if(to === 'foundation'){
      solitaireState.foundations[pile].push(card);
    }else{
      solitaireState.tableau[pile].push(...cards);
    }

    // Remove from source
    if(from === 'waste'){
      solitaireState.waste.pop();
    }else if(from === 'tableau'){
      solitaireState.tableau[fromPile].splice(index);
      // Flip top card if needed
      if(solitaireState.tableau[fromPile].length > 0){
        const lastCard = solitaireState.tableau[fromPile][solitaireState.tableau[fromPile].length - 1];
        lastCard.faceUp = true;
      }
    }

    playClickSound();
  }else{
    playErrorSound();
  }

  solitaireState.draggedFrom = null;
  renderSolitaire();
}

function flipTableauCard(pile){
  const tableau = solitaireState.tableau[pile];
  if(tableau.length > 0){
    const topCard = tableau[tableau.length - 1];
    if(!topCard.faceUp){
      topCard.faceUp = true;
      playClickSound();
      renderSolitaire();
    }
  }
}

function checkWin(){
  const totalInFoundations = solitaireState.foundations.reduce((sum, f) => sum + f.length, 0);
  if(totalInFoundations === 52){
    setTimeout(() => {
      alert('üéâ You Win! Congratulations!');
      playClickSound();
    }, 100);
  }
}

// Internet Explorer functions
function ieGo(){
  const urlInput = document.getElementById('ie-url');
  const frame = document.getElementById('ie-frame');
  if(urlInput && frame){
    frame.src = urlInput.value;
    playClickSound();
  }
}

function ieNavigate(direction){
  const frame = document.getElementById('ie-frame');
  if(frame && frame.contentWindow){
    if(direction < 0) frame.contentWindow.history.back();
    else frame.contentWindow.history.forward();
    playClickSound();
  }
}

function ieRefresh(){
  const frame = document.getElementById('ie-frame');
  if(frame){
    frame.src = frame.src;
    playClickSound();
  }
}

function ieHome(){
  const urlInput = document.getElementById('ie-url');
  const frame = document.getElementById('ie-frame');
  if(urlInput && frame){
    urlInput.value = 'https://www.bing.com';
    frame.src = 'https://www.bing.com';
    playClickSound();
  }
}

// Outlook Express functions
function showEmailFolder(folder){
  alert('Opening ' + folder + ' folder...');
  playClickSound();
}

function composeEmail(){
  alert('Compose new email:\n\nTo:\nSubject:\nMessage:\n\n(Demo mode - emails not actually sent)');
  playClickSound();
}

function refreshEmails(){
  alert('Checking for new emails...\n\nNo new messages.');
  playClickSound();
}

// Control Panel functions
function showThemeSettings(){
  const themes = ['blue', 'olive', 'silver', 'luna', 'royale', 'zune'];
  let choice = prompt('Choose a theme:\n1 - Classic Blue\n2 - Olive Green\n3 - Silver\n4 - Luna\n5 - Royale\n6 - Zune\n\nEnter number (1-6):');

  if(choice && choice >= 1 && choice <= 6){
    changeTheme(themes[choice - 1]);
  }
}

function showDisplaySettings(){
  const width = prompt('Enter default window width (200-800):', defaultWindowWidth);
  const height = prompt('Enter default window height (150-600):', defaultWindowHeight);

  if(width && !isNaN(width)){
    defaultWindowWidth = parseInt(width);
    playClickSound();
  }
  if(height && !isNaN(height)){
    defaultWindowHeight = parseInt(height);
    playClickSound();
  }
  savePreferences();
  alert('Display settings updated!');
}

function showSoundSettings(){
  alert('Sound Settings:\n\nüîä System sounds: Enabled\nüéµ Volume: 100%\n\n(Demo mode - actual volume controls not available)');
  playClickSound();
}

function showSystemInfo(){
  const storage = JSON.stringify(localStorage).length;
  const apps = Object.keys(apps).length;
  alert(`System Information:\n\nüíª OS: Windows XP Simulator\nüåê Browser: ${navigator.userAgent.split(' ').pop()}\nüì¶ Apps installed: ${apps}\nüíæ Storage used: ${(storage/1024).toFixed(2)} KB\n‚è∞ Session time: ${new Date().toLocaleTimeString()}`);
  playClickSound();
}

function showStorageSettings(){
  const storage = JSON.stringify(localStorage).length;
  const confirm = window.confirm(`Storage Information:\n\nUsed: ${(storage/1024).toFixed(2)} KB\n\nDo you want to clear all saved data?`);

  if(confirm){
    localStorage.clear();
    alert('All saved data cleared!');
    playClickSound();
  }
}

function showClockSettings(){
  use24Hour = !use24Hour;
  savePreferences();
  updateClock();
  alert(`Clock format changed to ${use24Hour ? '24-hour' : '12-hour'} format`);
  playClickSound();
}

// Save and load preferences
function savePreferences(){
  const prefs = {
    wallpaper: document.getElementById('desktop').style.backgroundImage,
    use24Hour: use24Hour,
    defaultWindowWidth: defaultWindowWidth,
    defaultWindowHeight: defaultWindowHeight
  };
  localStorage.setItem('xp-preferences', JSON.stringify(prefs));
}
function loadPreferences(){
  const saved = localStorage.getItem('xp-preferences');
  if(saved){
    const prefs = JSON.parse(saved);
    if(prefs.wallpaper) document.getElementById('desktop').style.backgroundImage = prefs.wallpaper;
    if(prefs.use24Hour !== undefined) use24Hour = prefs.use24Hour;
    if(prefs.defaultWindowWidth) defaultWindowWidth = prefs.defaultWindowWidth;
    if(prefs.defaultWindowHeight) defaultWindowHeight = prefs.defaultWindowHeight;
  }
  // Load theme
  const theme = localStorage.getItem('xp-theme');
  const themes = {
    'blue': {taskbar: 'linear-gradient(to bottom,#2584ff 0%,#0254cc 100%)'},
    'olive': {taskbar: 'linear-gradient(to bottom,#b4c99c 0%,#99b578 100%)'},
    'silver': {taskbar: 'linear-gradient(to bottom,#c1c9d3 0%,#a5adb8 100%)'},
    'luna': {taskbar: 'linear-gradient(to bottom,#1f4fd3 0%,#0831a8 100%)'},
    'royale': {taskbar: 'linear-gradient(to bottom,#6c8cd5 0%,#2a52be 100%)'},
    'zune': {taskbar: 'linear-gradient(to bottom,#f78d1e 0%,#d87208 100%)'}
  };
  if(theme && themes[theme]){
    document.querySelector('.taskbar').style.background = themes[theme].taskbar;
  }
}

// Change theme function
function changeTheme(themeName){
  const themes = {
    'blue': {taskbar: 'linear-gradient(to bottom,#2584ff 0%,#0254cc 100%)', name: 'Classic Blue'},
    'olive': {taskbar: 'linear-gradient(to bottom,#b4c99c 0%,#99b578 100%)', name: 'Olive Green'},
    'silver': {taskbar: 'linear-gradient(to bottom,#c1c9d3 0%,#a5adb8 100%)', name: 'Silver'},
    'luna': {taskbar: 'linear-gradient(to bottom,#1f4fd3 0%,#0831a8 100%)', name: 'Luna'},
    'royale': {taskbar: 'linear-gradient(to bottom,#6c8cd5 0%,#2a52be 100%)', name: 'Royale'},
    'zune': {taskbar: 'linear-gradient(to bottom,#f78d1e 0%,#d87208 100%)', name: 'Zune'}
  };

  if(themes[themeName]){
    document.querySelector('.taskbar').style.background = themes[themeName].taskbar;
    localStorage.setItem('xp-theme', themeName);
    alert('Theme changed to ' + themes[themeName].name);
    playClickSound();
  }
}

// Screensaver
let screensaverTimeout;
let screensaverActive = false;
function resetScreensaver(){
  clearTimeout(screensaverTimeout);
  if(screensaverActive){
    const ss = document.getElementById('screensaver');
    if(ss) ss.remove();
    screensaverActive = false;
  }
  screensaverTimeout = setTimeout(showScreensaver, 300000); // 5 minutes
}
function showScreensaver(){
  if(screensaverActive) return;
  screensaverActive = true;
  const ss = document.createElement('div');
  ss.id = 'screensaver';
  ss.style.position = 'fixed';
  ss.style.top = '0';
  ss.style.left = '0';
  ss.style.width = '100vw';
  ss.style.height = '100vh';
  ss.style.background = '#000';
  ss.style.zIndex = '100000';
  ss.style.display = 'flex';
  ss.style.alignItems = 'center';
  ss.style.justifyContent = 'center';
  ss.style.color = '#0f0';
  ss.style.fontSize = '48px';
  ss.style.fontFamily = 'Arial';
  ss.innerHTML = '<div style="animation: float 3s ease-in-out infinite;">Windows XP</div><style>@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}</style>';
  ss.addEventListener('click', resetScreensaver);
  ss.addEventListener('mousemove', resetScreensaver);
  document.body.appendChild(ss);
}
document.addEventListener('mousemove', resetScreensaver);
document.addEventListener('keydown', resetScreensaver);
document.addEventListener('click', resetScreensaver);
resetScreensaver();

// Simple sound effects using Web Audio API
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
function playSound(frequency, duration, type = 'sine'){
  try{
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  }catch(e){
    // Silently fail if audio not supported
  }
}
function playOpenSound(){
  playSound(800, 0.1);
}
function playCloseSound(){
  playSound(600, 0.1);
}
function playClickSound(){
  playSound(1000, 0.05);
}
function playErrorSound(){
  playSound(200, 0.2, 'square');
}

// Load preferences on start
window.addEventListener('load', () => {
  loadPreferences();
  setTimeout(initPaint, 500);
  setTimeout(initMinesweeper, 500);
});
const APP_VERSION = '1.0.0';
window.addEventListener('DOMContentLoaded', function () {
  const contextMenu = document.getElementById('custom-menu');
  const menuButton = document.getElementById('menu-button');
  const aboutModal = document.getElementById('about-modal');
  const aboutClose = document.getElementById('about-close');
  let previousFocus;
  const focusableSelector = 'a, button, input, textarea, select, [tabindex]:not([tabindex="-1"])';
  let modalFocusables = [];
  function trapFocus(e) {
      if (e.key === "Tab") {
        e.preventDefault();
        const items = modalFocusables;
        if (items.length === 0) {
          return;
        }
        let index = items.indexOf(document.activeElement);
        if (e.shiftKey) {
          index = index <= 0 ? items.length - 1 : index - 1;
        } else {
          index = index === items.length - 1 ? 0 : index + 1;
        }
        items[index].focus();
      } else if (e.key === "Escape") {
        aboutClose.click();
      }
    }
  document.getElementById('about-version').textContent = APP_VERSION;
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    contextMenu.style.display = 'block';
  });
  document.addEventListener('click', function (e) {
    if (!contextMenu.contains(e.target) && e.target !== menuButton) {
      contextMenu.style.display = 'none';
    }
  });
  menuButton.addEventListener('click', function () {
    if (draggingMenu) {
      draggingMenu = false;
      return;
    }
    const r = this.getBoundingClientRect();
    contextMenu.style.left = r.left + 'px';
    contextMenu.style.top = r.bottom + 'px';
    contextMenu.style.display = 'block';
  });
  document.getElementById('menu-refresh').addEventListener('click', function () {
    location.reload();
  });
  document.getElementById('menu-top').addEventListener('click', function () {
    contextMenu.classList.toggle('top');
  });
  document.getElementById('menu-size').addEventListener('click', function () {
      const w = prompt('Default window width:', defaultWindowWidth);
      if (w !== null) {
        const h = prompt('Default window height:', defaultWindowHeight);
        if (h !== null) {
          const nw = parseInt(w);
          const nh = parseInt(h);
          if (!isNaN(nw) && nw > 0) defaultWindowWidth = nw;
          if (!isNaN(nh) && nh > 0) defaultWindowHeight = nh;
        }
      }
      contextMenu.style.display = 'none';
    });
  document.getElementById('menu-wallpaper').addEventListener('click', function () {
    const desktop = document.getElementById('desktop');
    const current = getComputedStyle(desktop).backgroundImage;
    const match = current.match(/^url\(["']?(.*?)["']?\)$/i);
    const defaultUrl = match ? match[1] : '';
    const url = prompt('Enter wallpaper URL:', defaultUrl);
    if (url !== null) {
      if (url.trim() === '') {
        desktop.style.backgroundImage = 'none';
      } else {
        const escaped = url.replace(/'/g, "\\'");
        desktop.style.backgroundImage = `url('${escaped}')`;
      }
    }
    contextMenu.style.display = 'none';
  });
  document.getElementById("menu-about").addEventListener("click", function () {
    aboutModal.style.display = "flex";
    contextMenu.style.display = "none";
    previousFocus = document.activeElement;
    modalFocusables = Array.from(aboutModal.querySelectorAll(focusableSelector));
    aboutModal.addEventListener('keydown', trapFocus);
    if (modalFocusables.length > 0) {
      modalFocusables[0].focus();
    }
  });

  aboutClose.addEventListener("click", function () {
    aboutModal.removeEventListener('keydown', trapFocus);
    aboutModal.style.display = "none";
    if (previousFocus) previousFocus.focus();
  });

  window.addEventListener('click', function (e) {
    if (e.target === aboutModal) {
      aboutClose.click();
    }
  });
  document.getElementById('menu-move').addEventListener('click', function () {
    menuButtonMovable = !menuButtonMovable;
    menuButton.style.cursor = menuButtonMovable ? 'move' : 'pointer';
    contextMenu.style.display = 'none';
  });
  document.getElementById('menu-theme').addEventListener('click', function () {
    const choice = prompt('Choose theme:\n1 - Classic Blue\n2 - Olive Green\n3 - Silver\n4 - Luna\n5 - Royale\n6 - Zune', '1');
    const themeMap = {'1': 'blue', '2': 'olive', '3': 'silver', '4': 'luna', '5': 'royale', '6': 'zune'};
    const theme = themeMap[choice];
    if(theme){
      changeTheme(theme);
    }
    contextMenu.style.display = 'none';
  });
  document.getElementById('menu-minimize').addEventListener('click', function () {
    if (activeWindow) {
      activeWindow.classList.add('minimized');
      updateTaskbarItem(activeWindow);
    }
    contextMenu.style.display = 'none';
  });
    document.getElementById('menu-reset').addEventListener('click', function () {
      menuButton.style.left = '';
      menuButton.style.right = '20px';
      menuButton.style.top = '80px';
      contextMenu.style.display = 'none';
    });
    document.getElementById('menu-clock').addEventListener('click', function () {
      use24Hour = !use24Hour;
      updateClock();
      contextMenu.style.display = 'none';
    });
  document.getElementById('menu-close').addEventListener('click', function () {
    if (activeWindow) {
      activeWindow.remove();
      removeTaskbarItem(activeWindow);
    }
    contextMenu.style.display = 'none';
  });
});
</script>
<div id="custom-menu" class="context-menu">
  <ul>
    <li id="menu-refresh">Refresh</li>
    <li id="menu-top">Toggle On Top</li>
    <li id="menu-size">Set Window Size...</li>
    <li id="menu-theme">Change Theme...</li>
    <li id="menu-move">Move Menu Button</li>
    <li id="menu-wallpaper">Change Wallpaper...</li>
    <li id="menu-about">About</li>
    <li id="menu-minimize">Minimize Window</li>
      <li id="menu-reset">Reset Menu Position</li>
      <li id="menu-clock">Toggle Clock Format</li>
    <li id="menu-close">Close Window</li>
  </ul>
</div>
<button id="menu-button" class="open-menu-button">Menu</button>
<div id="about-modal" role="dialog" aria-modal="true" class="about-modal">
  <div class="about-modal-content">
    <span id="about-close" aria-label="Close" class="about-close">&times;</span>
    <h3>Windows XP Simulator</h3>
    <p>Version <span id="about-version"></span></p>
  </div>
</div>
<script>
  let lastMouseX = 0,
    lastMouseY = 0;
  document.addEventListener('mousemove', e => {
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
  });
  document.addEventListener("keydown", e => {
    if (aboutModal.style.display === "flex") {
      if (e.key === "Escape") {
        aboutClose.click();
      } else if (e.key === "Tab") {
        trapFocus(e);
      }
    } else if (e.key === "ContextMenu") {
      contextMenu.style.left = lastMouseX + "px";
      contextMenu.style.top = lastMouseY + "px";
      contextMenu.style.display = "block";
      e.preventDefault();
    }
  });
  let draggingMenu = false,
    offsetX = 0,
    offsetY = 0,
    menuButtonMovable = true;
  menuButton.addEventListener('mousedown', function (e) {
    if (e.button !== 0 || !menuButtonMovable) return;
    draggingMenu = true;
    const r = menuButton.getBoundingClientRect();
    offsetX = e.clientX - r.left;
    offsetY = e.clientY - r.top;
    menuButton.style.right = 'auto';
  });
  document.addEventListener('mousemove', function (e) {
    if (!draggingMenu) return;
    menuButton.style.left = e.clientX - offsetX + 'px';
    menuButton.style.top = e.clientY - offsetY + 'px';
  });
  document.addEventListener('mouseup', function () {
    draggingMenu = false;
  });

// ========== NEW APPLICATIONS FUNCTIONS ==========

// Command Prompt functions
let cmdHistory = [];
let cmdHistoryIndex = 0;
let cmdCurrentPath = 'C:\\My Documents';

function cmdKeyHandler(event){
  const input = document.getElementById('cmd-input');
  if(!input) return;

  if(event.key === 'Enter'){
    executeCommand();
  } else if(event.key === 'ArrowUp'){
    event.preventDefault();
    if(cmdHistoryIndex > 0){
      cmdHistoryIndex--;
      input.value = cmdHistory[cmdHistoryIndex] || '';
    }
  } else if(event.key === 'ArrowDown'){
    event.preventDefault();
    if(cmdHistoryIndex < cmdHistory.length - 1){
      cmdHistoryIndex++;
      input.value = cmdHistory[cmdHistoryIndex] || '';
    } else if(cmdHistoryIndex === cmdHistory.length - 1){
      cmdHistoryIndex = cmdHistory.length;
      input.value = '';
    }
  } else if(event.key === 'Tab'){
    event.preventDefault();
    // Auto-complete file/folder names
    const partial = input.value.toLowerCase();
    const items = vfs.listDirectory(cmdCurrentPath);
    if(items){
      const matches = Object.keys(items).filter(name => name.toLowerCase().startsWith(partial));
      if(matches.length === 1){
        input.value = matches[0];
      } else if(matches.length > 1){
        const output = document.getElementById('cmd-output');
        if(output){
          output.innerHTML += `<div style="margin-bottom:10px;">${matches.join('  ')}</div>`;
          output.scrollTop = output.scrollHeight;
        }
      }
    }
  }
}

function executeCommand(){
  const input = document.getElementById('cmd-input');
  const output = document.getElementById('cmd-output');
  const prompt = document.getElementById('cmd-prompt');

  if(!input || !output) return;

  const command = input.value.trim();
  if(!command) return;

  cmdHistory.push(command);
  cmdHistoryIndex = cmdHistory.length;

  output.innerHTML += `<div>${prompt.textContent} ${command}</div>`;

  const parts = command.split(' ');
  const cmd = parts[0].toLowerCase();
  const args = parts.slice(1);

  let result = '';
  switch(cmd){
    case 'help':
      result = `<strong style="color:#00ff00;">Available Commands:</strong><br><br>
<strong>File Operations:</strong><br>
  dir - List directory contents<br>
  cd [path] - Change directory<br>
  mkdir [name] - Create directory<br>
  rmdir [name] - Remove directory<br>
  type [file] - Display file contents<br>
  del [file] - Delete file<br>
  copy [src] [dst] - Copy file<br>
  move [src] [dst] - Move file<br>
  rename [old] [new] - Rename file<br>
  tree - Display directory tree<br>
  find [text] - Search for text in files<br>
  attrib - Display file attributes<br><br>
<strong>System Information:</strong><br>
  ver - Show system version<br>
  systeminfo - Display detailed system info<br>
  whoami - Display current user<br>
  hostname - Display computer name<br>
  date - Show current date<br>
  time - Show current time<br>
  path - Display PATH variable<br><br>
<strong>Network:</strong><br>
  ipconfig - Display IP configuration<br>
  ping [host] - Ping a host<br><br>
<strong>Process Management:</strong><br>
  tasklist - List running processes<br>
  start [app] - Start an application<br><br>
<strong>Utilities:</strong><br>
  echo [msg] - Display message<br>
  cls - Clear screen<br>
  color [attr] - Change console colors (e.g., color 0A)<br>
  calc - Open calculator<br>
  notepad - Open notepad<br>
  paint - Open paint<br>
  explorer - Open file explorer<br>
  exit - Close window<br>
  help - Show this help`;
      break;
    case 'dir':
      const items = vfs.listDirectory(cmdCurrentPath);
      if(items){
        result = `Directory of ${cmdCurrentPath}<br><br>`;
        let fileCount = 0, dirCount = 0;
        Object.keys(items).forEach(name => {
          const item = items[name];
          if(item.type === 'folder'){
            result += `&lt;DIR&gt;        ${name}<br>`;
            dirCount++;
          } else {
            const size = item.content ? item.content.length : 0;
            result += `              ${size.toString().padStart(8)} ${name}<br>`;
            fileCount++;
          }
        });
        result += `<br>     ${dirCount} Dir(s)   ${fileCount} File(s)`;
      } else {
        result = 'Directory not found';
      }
      break;
    case 'cd':
      if(args.length === 0){
        result = cmdCurrentPath;
      } else {
        let newPath = args[0];
        if(!newPath.startsWith('C:')){
          newPath = cmdCurrentPath === 'C:\\' ? 'C:\\' + newPath : cmdCurrentPath + '\\' + newPath;
        }
        if(vfs.navigatePath(newPath)){
          cmdCurrentPath = newPath;
          prompt.textContent = cmdCurrentPath + '>';
        } else {
          result = 'The system cannot find the path specified.';
        }
      }
      break;
    case 'mkdir':
      if(args.length === 0){
        result = 'The syntax of the command is incorrect.';
      } else {
        if(vfs.createFolder(cmdCurrentPath, args[0])){
          result = `Created directory: ${args[0]}`;
        } else {
          result = 'Failed to create directory. It may already exist.';
        }
      }
      break;
    case 'rmdir':
      if(args.length === 0){
        result = 'The syntax of the command is incorrect.';
      } else {
        if(vfs.deleteItem(cmdCurrentPath, args[0])){
          result = `Deleted directory: ${args[0]}`;
        } else {
          result = 'Failed to delete directory.';
        }
      }
      break;
    case 'type':
      if(args.length === 0){
        result = 'The syntax of the command is incorrect.';
      } else {
        const file = vfs.readFile(cmdCurrentPath, args[0]);
        if(file){
          result = file.content.replace(/\n/g, '<br>');
        } else {
          result = 'The system cannot find the file specified.';
        }
      }
      break;
    case 'del':
      if(args.length === 0){
        result = 'The syntax of the command is incorrect.';
      } else {
        if(vfs.deleteItem(cmdCurrentPath, args[0])){
          result = `Deleted: ${args[0]}`;
        } else {
          result = 'The system cannot find the file specified.';
        }
      }
      break;
    case 'rename':
      if(args.length < 2){
        result = 'The syntax of the command is incorrect.';
      } else {
        if(vfs.renameItem(cmdCurrentPath, args[0], args[1])){
          result = `Renamed ${args[0]} to ${args[1]}`;
        } else {
          result = 'Failed to rename. File may not exist or new name already exists.';
        }
      }
      break;
    case 'cls':
      output.innerHTML = '';
      break;
    case 'date':
      result = new Date().toLocaleDateString();
      break;
    case 'time':
      result = new Date().toLocaleTimeString();
      break;
    case 'ver':
      result = 'Microsoft Windows XP [Version 5.1.2600] (Simulator with Virtual File System)';
      break;
    case 'echo':
      result = args.join(' ');
      break;
    case 'calc':
      createWindow('calculator', 250, 400);
      result = 'Opening Calculator...';
      break;
    case 'notepad':
      createWindow('notepad');
      result = 'Opening Notepad...';
      break;
    case 'explorer':
      createWindow('file-explorer');
      result = 'Opening File Explorer...';
      break;
    case 'copy':
      if(args.length < 2){
        result = 'The syntax of the command is incorrect.<br>Usage: copy [source] [destination]';
      } else {
        const sourceFile = vfs.readFile(cmdCurrentPath, args[0]);
        if(sourceFile){
          if(vfs.createFile(cmdCurrentPath, args[1], sourceFile.content, sourceFile.fileType)){
            result = `Copied ${args[0]} to ${args[1]}`;
          } else {
            result = 'Failed to copy file.';
          }
        } else {
          result = 'The system cannot find the file specified.';
        }
      }
      break;
    case 'move':
      if(args.length < 2){
        result = 'The syntax of the command is incorrect.<br>Usage: move [source] [destination]';
      } else {
        const sourceFile = vfs.readFile(cmdCurrentPath, args[0]);
        if(sourceFile){
          if(vfs.createFile(cmdCurrentPath, args[1], sourceFile.content, sourceFile.fileType)){
            vfs.deleteItem(cmdCurrentPath, args[0]);
            result = `Moved ${args[0]} to ${args[1]}`;
          } else {
            result = 'Failed to move file.';
          }
        } else {
          result = 'The system cannot find the file specified.';
        }
      }
      break;
    case 'tree':
      result = `Directory structure of ${cmdCurrentPath}<br><br>`;
      const treeItems = vfs.listDirectory(cmdCurrentPath);
      if(treeItems){
        Object.keys(treeItems).forEach((name, index) => {
          const item = treeItems[name];
          const isLast = index === Object.keys(treeItems).length - 1;
          const prefix = isLast ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
          const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
          result += `${prefix}${icon} ${name}<br>`;
        });
      }
      break;
    case 'find':
      if(args.length === 0){
        result = 'The syntax of the command is incorrect.<br>Usage: find [text]';
      } else {
        const searchText = args.join(' ').toLowerCase();
        const items = vfs.listDirectory(cmdCurrentPath);
        let found = false;
        result = `Searching for "${searchText}" in ${cmdCurrentPath}<br><br>`;
        if(items){
          Object.keys(items).forEach(name => {
            const item = items[name];
            if(item.type === 'file' && item.content){
              const lines = item.content.split('\n');
              lines.forEach((line, lineNum) => {
                if(line.toLowerCase().includes(searchText)){
                  result += `${name} (line ${lineNum + 1}): ${line}<br>`;
                  found = true;
                }
              });
            }
          });
        }
        if(!found){
          result += 'No matches found.';
        }
      }
      break;
    case 'whoami':
      result = 'WINXP\\User';
      break;
    case 'hostname':
      result = 'WINXP-SIMULATOR';
      break;
    case 'systeminfo':
      result = `Host Name:                 WINXP-SIMULATOR<br>
OS Name:                   Microsoft Windows XP Professional<br>
OS Version:                5.1.2600 Service Pack 3 Build 2600<br>
OS Manufacturer:           Microsoft Corporation<br>
System Type:               x86-based PC<br>
Processor:                 Intel(R) Pentium(R) 4 CPU 3.00GHz<br>
Total Physical Memory:     512 MB<br>
Available Physical Memory: ${Math.floor(Math.random() * 200 + 100)} MB<br>
Virtual Memory:            1024 MB<br>
Page File Location:        C:\\pagefile.sys`;
      break;
    case 'tasklist':
      result = `Image Name                     PID Session Name        Session#    Mem Usage<br>`;
      result += `========================= ======== ================ =========== ============<br>`;
      result += `System Idle Process              0 Services                   0         24 K<br>`;
      result += `System                           4 Services                   0        236 K<br>`;
      result += `smss.exe                       368 Services                   0        416 K<br>`;
      result += `csrss.exe                      596 Console                    0      4,556 K<br>`;
      result += `winlogon.exe                   620 Console                    0      2,800 K<br>`;
      result += `explorer.exe                  1484 Console                    0     14,228 K<br>`;
      const windows = document.querySelectorAll('.window');
      windows.forEach((w, i) => {
        const title = w.querySelector('.window-header span').textContent;
        const pid = 2000 + i;
        const mem = Math.floor(Math.random() * 10000 + 5000);
        result += `${title.padEnd(30)} ${pid.toString().padStart(8)} Console         ${' '.repeat(11)}0 ${mem.toString().padStart(9)} K<br>`;
      });
      break;
    case 'ipconfig':
      result = `Windows IP Configuration<br><br>`;
      result += `Ethernet adapter Local Area Connection:<br><br>`;
      result += `   Connection-specific DNS Suffix  . :<br>`;
      result += `   IP Address. . . . . . . . . . . . : 192.168.1.${Math.floor(Math.random() * 200 + 10)}<br>`;
      result += `   Subnet Mask . . . . . . . . . . . : 255.255.255.0<br>`;
      result += `   Default Gateway . . . . . . . . . : 192.168.1.1`;
      break;
    case 'ping':
      if(args.length === 0){
        result = 'Usage: ping [hostname]';
      } else {
        const host = args[0];
        result = `Pinging ${host} with 32 bytes of data:<br><br>`;
        for(let i = 0; i < 4; i++){
          const time = Math.floor(Math.random() * 50 + 10);
          result += `Reply from ${host}: bytes=32 time=${time}ms TTL=64<br>`;
        }
        result += `<br>Ping statistics for ${host}:<br>`;
        result += `    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss)`;
      }
      break;
    case 'color':
      if(args.length === 0){
        result = 'Sets the default console foreground and background colors.<br>Usage: color [attr]<br>Example: color 0A (black background, green text)';
      } else {
        const colorCode = args[0].toLowerCase();
        const cmdOutput = document.getElementById('cmd-output');
        const cmdInput = document.getElementById('cmd-input');
        const cmdPrompt = document.getElementById('cmd-prompt');
        const cmdWin = cmdOutput ? cmdOutput.closest('.window-content').parentElement : null;

        const colors = {
          '0': '#000', '1': '#000080', '2': '#008000', '3': '#008080',
          '4': '#800000', '5': '#800080', '6': '#808000', '7': '#c0c0c0',
          '8': '#808080', '9': '#0000ff', 'a': '#00ff00', 'b': '#00ffff',
          'c': '#ff0000', 'd': '#ff00ff', 'e': '#ffff00', 'f': '#ffffff'
        };

        if(colorCode.length === 2){
          const bg = colors[colorCode[0]];
          const fg = colors[colorCode[1]];
          if(bg && fg && cmdWin){
            cmdWin.querySelector('.window-content').style.background = bg;
            if(cmdOutput) cmdOutput.style.color = fg;
            if(cmdInput) cmdInput.style.color = fg;
            if(cmdPrompt) cmdPrompt.style.color = fg;
            result = 'Color changed successfully.';
          } else {
            result = 'Invalid color code.';
          }
        } else {
          result = 'Invalid color code. Use format: color [bg][fg] (e.g., 0A)';
        }
      }
      break;
    case 'attrib':
      if(args.length === 0){
        const items = vfs.listDirectory(cmdCurrentPath);
        if(items){
          result = '';
          Object.keys(items).forEach(name => {
            const attr = items[name].type === 'folder' ? 'D' : 'A';
            result += `${attr}         ${cmdCurrentPath}\\${name}<br>`;
          });
        }
      } else {
        result = 'Attribute display for specific files is not yet implemented.';
      }
      break;
    case 'path':
      result = `PATH=${cmdCurrentPath};C:\\Windows\\System32;C:\\Windows;C:\\Program Files`;
      break;
    case 'start':
      if(args.length === 0){
        result = 'Usage: start [application]<br>Examples: start calc, start notepad, start paint';
      } else {
        const appName = args[0].toLowerCase();
        const appMap = {
          'calc': 'calculator',
          'calculator': 'calculator',
          'notepad': 'notepad',
          'paint': 'paint',
          'minesweeper': 'minesweeper',
          'solitaire': 'solitaire',
          'explorer': 'file-explorer'
        };
        if(appMap[appName]){
          createWindow(appMap[appName]);
          result = `Starting ${appName}...`;
        } else {
          result = `Application '${appName}' not found.`;
        }
      }
      break;
    case 'exit':
      if(activeWindow) activeWindow.remove();
      break;
    default:
      result = `'${command}' is not recognized as an internal or external command.<br>Type 'help' for available commands.`;
      playErrorSound();
  }

  if(result) output.innerHTML += `<div style="margin-bottom:10px;">${result}</div>`;
  output.scrollTop = output.scrollHeight;
  input.value = '';
}

// File Explorer functions
let explorerHistory = ['C:\\My Documents'];
let explorerHistoryIndex = 0;
let explorerCurrentPath = 'C:\\My Documents';

function explorerNavigate(path, addToHistory = true){
  const pathInput = document.getElementById('explorer-path');
  const content = document.getElementById('explorer-content');

  if(!content) return;

  // Add to history
  if(addToHistory){
    explorerHistory = explorerHistory.slice(0, explorerHistoryIndex + 1);
    explorerHistory.push(path);
    explorerHistoryIndex = explorerHistory.length - 1;
  }

  explorerCurrentPath = path;
  if(pathInput) pathInput.value = path;

  // Get directory contents from VFS
  const items = vfs.listDirectory(path);

  if(!items){
    content.innerHTML = '<div style="color:red;padding:20px;">Directory not found</div>';
    return;
  }

  const icons = {
    '.txt': 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png',
    '.doc': 'https://cdn-icons-png.flaticon.com/512/3143/3143609.png',
    '.jpg': 'https://cdn-icons-png.flaticon.com/512/3342/3342137.png',
    '.png': 'https://cdn-icons-png.flaticon.com/512/3342/3342137.png',
    '.mp3': 'https://cdn-icons-png.flaticon.com/512/2965/2965307.png',
    'folder': 'https://cdn-icons-png.flaticon.com/512/148/148947.png',
    'file': 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png'
  };

  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,100px);gap:20px;">';

  Object.keys(items).forEach(name => {
    const item = items[name];
    let icon;

    if(item.type === 'folder'){
      icon = icons['folder'];
    } else {
      const ext = name.includes('.') ? name.substring(name.lastIndexOf('.')) : '';
      icon = icons[ext] || icons['file'];
    }

    const onclick = item.type === 'folder'
      ? `explorerNavigate('${path}\\\\${name}')`
      : `explorerOpenFile('${name}')`;

    html += `<div style="text-align:center;cursor:pointer;position:relative;"
             ondblclick="${onclick}"
             oncontextmenu="explorerContextMenu(event, '${name}', '${item.type}'); return false;">
      <img src="${icon}" style="width:48px;height:48px;"><br>
      <span style="font-size:11px;word-break:break-all;">${name}</span>
    </div>`;
  });

  if(Object.keys(items).length === 0){
    html += '<div style="color:#999;padding:20px;">This folder is empty</div>';
  }

  html += '</div>';
  content.innerHTML = html;
  playClickSound();
}

function explorerBack(){
  if(explorerHistoryIndex > 0){
    explorerHistoryIndex--;
    explorerNavigate(explorerHistory[explorerHistoryIndex], false);
  }
}

function explorerForward(){
  if(explorerHistoryIndex < explorerHistory.length - 1){
    explorerHistoryIndex++;
    explorerNavigate(explorerHistory[explorerHistoryIndex], false);
  }
}

function explorerUp(){
  const current = explorerCurrentPath;
  if(current === 'C:' || current === 'C:\\') return;

  const lastSlash = current.lastIndexOf('\\');
  const parent = lastSlash > 2 ? current.substring(0, lastSlash) : 'C:\\';
  explorerNavigate(parent);
}

function explorerRefresh(){
  explorerNavigate(explorerCurrentPath, false);
}

function explorerNewFile(){
  const filename = prompt('Enter file name:');
  if(!filename) return;

  if(vfs.createFile(explorerCurrentPath, filename, '')){
    showNotification('File Explorer', `Created file: ${filename}`);
    explorerRefresh();
  } else {
    alert('Failed to create file. File may already exist.');
  }
}

function explorerNewFolder(){
  const foldername = prompt('Enter folder name:');
  if(!foldername) return;

  if(vfs.createFolder(explorerCurrentPath, foldername)){
    showNotification('File Explorer', `Created folder: ${foldername}`);
    explorerRefresh();
  } else {
    alert('Failed to create folder. Folder may already exist.');
  }
}

function explorerOpenFile(filename){
  const file = vfs.readFile(explorerCurrentPath, filename);
  if(!file) return;

  // Determine how to open based on file type
  if(filename.endsWith('.txt') || !filename.includes('.')){
    // Open in Notepad
    const win = createWindow('notepad');
    setTimeout(() => {
      const textarea = win.querySelector('.notepad-text');
      if(textarea){
        textarea.value = file.content;
        textarea.dataset.filepath = explorerCurrentPath;
        textarea.dataset.filename = filename;
      }
    }, 100);
  } else if(filename.match(/\.(jpg|jpeg|png|gif)$/i)){
    // Open in Photo Viewer
    const win = createWindow('photo-viewer');
    setTimeout(() => {
      const container = win.querySelector('#photo-container');
      if(container && file.content){
        container.innerHTML = `<img src="${file.content}" style="max-width:100%;max-height:100%;">`;
      }
    }, 100);
  } else {
    alert('File type not supported for viewing');
  }
}

let explorerContextItem = null;
let explorerContextType = null;

function explorerContextMenu(e, itemname, itemtype){
  e.preventDefault();

  explorerContextItem = itemname;
  explorerContextType = itemtype;

  // Remove existing context menu
  const existing = document.getElementById('explorer-context-menu');
  if(existing) existing.remove();

  // Create context menu
  const menu = document.createElement('div');
  menu.id = 'explorer-context-menu';
  menu.style.cssText = `position:fixed;left:${e.clientX}px;top:${e.clientY}px;background:#f0f0f0;border:1px solid #999;z-index:10000;min-width:150px;box-shadow:2px 2px 5px rgba(0,0,0,0.3);`;

  const items = [
    { label: 'üìÇ Open', action: () => itemtype === 'folder' ? explorerNavigate(`${explorerCurrentPath}\\${itemname}`) : explorerOpenFile(itemname) },
    { label: '‚úèÔ∏è Rename', action: () => explorerRenameItem(itemname) },
    { label: 'üìã Copy', action: () => alert('Copy functionality coming soon') },
    { label: 'üóëÔ∏è Delete', action: () => explorerDeleteItem(itemname) }
  ];

  items.forEach(item => {
    const div = document.createElement('div');
    div.textContent = item.label;
    div.style.cssText = 'padding:8px 15px;cursor:pointer;';
    div.onmouseover = () => div.style.background = '#0a246a';
    div.onmouseout = () => div.style.background = 'transparent';
    div.onmouseover = () => { div.style.background = '#0a246a'; div.style.color = '#fff'; };
    div.onmouseout = () => { div.style.background = 'transparent'; div.style.color = '#000'; };
    div.onclick = () => {
      item.action();
      menu.remove();
    };
    menu.appendChild(div);
  });

  document.body.appendChild(menu);

  // Close menu on outside click
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(){
      menu.remove();
      document.removeEventListener('click', closeMenu);
    });
  }, 10);
}

function explorerRenameItem(itemname){
  const newname = prompt(`Rename "${itemname}" to:`, itemname);
  if(!newname || newname === itemname) return;

  if(vfs.renameItem(explorerCurrentPath, itemname, newname)){
    showNotification('File Explorer', `Renamed to: ${newname}`);
    explorerRefresh();
  } else {
    alert('Failed to rename. New name may already exist.');
  }
}

function explorerDeleteItem(itemname){
  if(!confirm(`Delete "${itemname}"?`)) return;

  if(vfs.deleteItem(explorerCurrentPath, itemname)){
    showNotification('File Explorer', `Moved to Recycle Bin: ${itemname}`);
    explorerRefresh();
  } else {
    alert('Failed to delete item.');
  }
}

// Recycle Bin functions
function recycleBinRefresh(){
  const content = document.getElementById('recycle-content');
  if(!content) return;

  const items = vfs.getRecycleBinItems();

  if(items.length === 0){
    content.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">Recycle Bin is empty</div>';
    return;
  }

  const icons = {
    'folder': 'https://cdn-icons-png.flaticon.com/512/148/148947.png',
    'file': 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png'
  };

  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,100px);gap:20px;">';

  items.forEach((recycled, index) => {
    const icon = recycled.item.type === 'folder' ? icons['folder'] : icons['file'];
    const date = new Date(recycled.deletedDate).toLocaleString();

    html += `<div style="text-align:center;cursor:pointer;position:relative;"
             ondblclick="recycleBinRestore(${index})"
             title="Deleted: ${date}">
      <img src="${icon}" style="width:48px;height:48px;opacity:0.7;"><br>
      <span style="font-size:11px;word-break:break-all;">${recycled.name}</span>
      <div style="font-size:9px;color:#999;">From: ${recycled.path}</div>
    </div>`;
  });

  html += '</div>';
  content.innerHTML = html;
}

function recycleBinEmpty(){
  if(!confirm('Are you sure you want to permanently delete all items in the Recycle Bin?')) return;

  vfs.emptyRecycleBin();
  showNotification('Recycle Bin', 'Recycle Bin has been emptied');
  recycleBinRefresh();
}

function recycleBinRestore(index){
  if(vfs.restoreFromRecycleBin(index)){
    const items = vfs.getRecycleBinItems();
    showNotification('Recycle Bin', 'Item restored successfully');
    recycleBinRefresh();
  } else {
    alert('Failed to restore item. Original location may no longer exist.');
  }
}

// System Properties functions
let systemStartTime = Date.now();

function updateSystemProperties(){
  const cpuUsage = Math.floor(Math.random() * 30) + 10;
  const memUsage = Math.floor(Math.random() * 40) + 20;

  const uptimeMs = Date.now() - systemStartTime;
  const hours = Math.floor(uptimeMs / 3600000);
  const minutes = Math.floor((uptimeMs % 3600000) / 60000);
  const seconds = Math.floor((uptimeMs % 60000) / 1000);

  const cpuEl = document.getElementById('sys-cpu');
  const memEl = document.getElementById('sys-mem');
  const uptimeEl = document.getElementById('sys-uptime');

  if(cpuEl) cpuEl.textContent = cpuUsage + '%';
  if(memEl) memEl.textContent = memUsage + '%';
  if(uptimeEl) uptimeEl.textContent = `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

  playClickSound();
}

// Volume Control functions
let masterVolume = 75;
let isMuted = false;

function updateVolume(){
  const slider = document.getElementById('master-volume');
  const display = document.getElementById('volume-display');

  if(slider) masterVolume = slider.value;
  if(display) display.textContent = masterVolume + '%';

  if(isMuted) isMuted = false;
  updateMuteButton();
}

function toggleMute(){
  isMuted = !isMuted;
  updateMuteButton();
  playClickSound();
}

function updateMuteButton(){
  const btn = document.getElementById('mute-btn');
  if(btn){
    btn.textContent = isMuted ? 'üîá Unmute' : 'üîä Mute';
  }
}

// Pong Game
let pongGame = null;
let pongScore1 = 0;
let pongScore2 = 0;

function initPong(){
  const canvas = document.getElementById('pong-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  // Draw initial court
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, width, height);

  // Draw center line
  ctx.strokeStyle = '#fff';
  ctx.setLineDash([10, 5]);
  ctx.beginPath();
  ctx.moveTo(width / 2, 0);
  ctx.lineTo(width / 2, height);
  ctx.stroke();
  ctx.setLineDash([]);

  // Draw paddles
  const paddleHeight = 100;
  const paddleWidth = 10;
  ctx.fillStyle = '#fff';
  ctx.fillRect(5, height / 2 - paddleHeight / 2, paddleWidth, paddleHeight);
  ctx.fillRect(width - paddleWidth - 5, height / 2 - paddleHeight / 2, paddleWidth, paddleHeight);

  // Draw ball
  ctx.fillRect(width / 2 - 5, height / 2 - 5, 10, 10);

  // Draw "Press Start" message
  ctx.font = '24px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Press START to begin!', width / 2, 40);

  // Reset scores
  document.getElementById('pong-score1').textContent = '0';
  document.getElementById('pong-score2').textContent = '0';
}

function startPong(){
  const canvas = document.getElementById('pong-canvas');
  if(!canvas) return;

  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  if(pongGame) clearInterval(pongGame);

  pongScore1 = 0;
  pongScore2 = 0;

  let paddle1Y = height / 2 - 50;
  let paddle2Y = height / 2 - 50;
  let ballX = width / 2;
  let ballY = height / 2;
  let ballDX = 3;
  let ballDY = 3;

  const paddleWidth = 10;
  const paddleHeight = 100;
  const ballSize = 10;

  const keys = {};
  const keyHandler = e => {
    if(e.key === 'w' || e.key === 'W') keys['w'] = e.type === 'keydown';
    if(e.key === 's' || e.key === 'S') keys['s'] = e.type === 'keydown';
  };
  document.addEventListener('keydown', keyHandler);
  document.addEventListener('keyup', keyHandler);

  pongGame = setInterval(() => {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, width, height);

    // Move paddles
    if(keys['w'] && paddle1Y > 0) paddle1Y -= 5;
    if(keys['s'] && paddle1Y < height - paddleHeight) paddle1Y += 5;

    // AI paddle
    if(ballY < paddle2Y + paddleHeight / 2) paddle2Y -= 3;
    if(ballY > paddle2Y + paddleHeight / 2) paddle2Y += 3;

    // Move ball
    ballX += ballDX;
    ballY += ballDY;

    // Ball collision with top/bottom
    if(ballY <= 0 || ballY >= height - ballSize) ballDY = -ballDY;

    // Ball collision with paddles
    if(ballX <= paddleWidth && ballY >= paddle1Y && ballY <= paddle1Y + paddleHeight){
      ballDX = -ballDX;
      playClickSound();
    }
    if(ballX >= width - paddleWidth - ballSize && ballY >= paddle2Y && ballY <= paddle2Y + paddleHeight){
      ballDX = -ballDX;
      playClickSound();
    }

    // Score
    if(ballX <= 0){
      pongScore2++;
      document.getElementById('pong-score2').textContent = pongScore2;
      ballX = width / 2;
      ballY = height / 2;
      playErrorSound();
    }
    if(ballX >= width){
      pongScore1++;
      document.getElementById('pong-score1').textContent = pongScore1;
      ballX = width / 2;
      ballY = height / 2;
      playClickSound();
    }

    // Draw
    ctx.fillStyle = '#fff';
    ctx.fillRect(5, paddle1Y, paddleWidth, paddleHeight);
    ctx.fillRect(width - paddleWidth - 5, paddle2Y, paddleWidth, paddleHeight);
    ctx.fillRect(ballX, ballY, ballSize, ballSize);

    // Center line
    for(let i = 0; i < height; i += 20){
      ctx.fillRect(width / 2 - 2, i, 4, 10);
    }
  }, 1000/60);
}

function pausePong(){
  if(pongGame) clearInterval(pongGame);
}

// Breakout Game
let breakoutGame = null;
let breakoutScore = 0;
let breakoutLives = 3;
let breakoutLevel = 1;

function initBreakout(){
  const canvas = document.getElementById('breakout-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  // Draw initial screen
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, width, height);

  // Draw bricks preview
  const brickRows = 5;
  const brickCols = 8;
  const brickWidth = width / brickCols - 5;
  const brickHeight = 20;
  const colors = ['#f00', '#ff0', '#0f0', '#0ff', '#00f'];

  for(let r = 0; r < brickRows; r++){
    for(let c = 0; c < brickCols; c++){
      ctx.fillStyle = colors[r];
      const x = c * (brickWidth + 5);
      const y = r * (brickHeight + 5) + 30;
      ctx.fillRect(x, y, brickWidth, brickHeight);
    }
  }

  // Draw paddle
  const paddleWidth = 100;
  const paddleHeight = 10;
  ctx.fillStyle = '#fff';
  ctx.fillRect(width / 2 - paddleWidth / 2, height - 20, paddleWidth, paddleHeight);

  // Draw ball
  ctx.fillRect(width / 2 - 5, height - 35, 10, 10);

  // Draw "Press Start" message
  ctx.fillStyle = '#fff';
  ctx.font = '24px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Press START to begin!', width / 2, height / 2);

  // Reset scores
  document.getElementById('breakout-score').textContent = '0';
  document.getElementById('breakout-lives').textContent = '3';
  document.getElementById('breakout-level').textContent = '1';
}

function startBreakout(){
  const canvas = document.getElementById('breakout-canvas');
  if(!canvas) return;

  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  if(breakoutGame) clearInterval(breakoutGame);

  breakoutScore = 0;
  breakoutLives = 3;
  breakoutLevel = 1;

  document.getElementById('breakout-score').textContent = breakoutScore;
  document.getElementById('breakout-lives').textContent = breakoutLives;
  document.getElementById('breakout-level').textContent = breakoutLevel;

  let paddleX = width / 2 - 50;
  const paddleWidth = 100;
  const paddleHeight = 10;

  let ballX = width / 2;
  let ballY = height - 30;
  let ballDX = 3;
  let ballDY = -3;
  const ballSize = 10;

  const brickRows = 5;
  const brickCols = 8;
  const brickWidth = width / brickCols - 5;
  const brickHeight = 20;
  let bricks = [];

  for(let r = 0; r < brickRows; r++){
    bricks[r] = [];
    for(let c = 0; c < brickCols; c++){
      bricks[r][c] = 1;
    }
  }

  const mouseMove = e => {
    const rect = canvas.getBoundingClientRect();
    paddleX = e.clientX - rect.left - paddleWidth / 2;
    if(paddleX < 0) paddleX = 0;
    if(paddleX > width - paddleWidth) paddleX = width - paddleWidth;
  };

  const keyDown = e => {
    if(e.key === 'ArrowLeft' && paddleX > 0) paddleX -= 20;
    if(e.key === 'ArrowRight' && paddleX < width - paddleWidth) paddleX += 20;
  };

  canvas.addEventListener('mousemove', mouseMove);
  document.addEventListener('keydown', keyDown);

  breakoutGame = setInterval(() => {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, width, height);

    // Move ball
    ballX += ballDX;
    ballY += ballDY;

    // Ball collision
    if(ballX <= 0 || ballX >= width - ballSize) ballDX = -ballDX;
    if(ballY <= 0) ballDY = -ballDY;

    // Paddle collision
    if(ballY >= height - paddleHeight - ballSize && ballX >= paddleX && ballX <= paddleX + paddleWidth){
      ballDY = -ballDY;
      playClickSound();
    }

    // Brick collision
    for(let r = 0; r < brickRows; r++){
      for(let c = 0; c < brickCols; c++){
        if(bricks[r][c]){
          const bx = c * (brickWidth + 5);
          const by = r * (brickHeight + 5) + 30;

          if(ballX >= bx && ballX <= bx + brickWidth && ballY >= by && ballY <= by + brickHeight){
            ballDY = -ballDY;
            bricks[r][c] = 0;
            breakoutScore += 10;
            document.getElementById('breakout-score').textContent = breakoutScore;
            playClickSound();
          }
        }
      }
    }

    // Ball out
    if(ballY >= height){
      breakoutLives--;
      document.getElementById('breakout-lives').textContent = breakoutLives;
      playErrorSound();

      if(breakoutLives <= 0){
        clearInterval(breakoutGame);
        canvas.removeEventListener('mousemove', mouseMove);
        document.removeEventListener('keydown', keyDown);
        alert('Game Over! Score: ' + breakoutScore);
        return;
      }

      ballX = width / 2;
      ballY = height - 30;
      ballDX = 3;
      ballDY = -3;
    }

    // Draw bricks
    const colors = ['#f00', '#ff0', '#0f0', '#0ff', '#00f'];
    for(let r = 0; r < brickRows; r++){
      for(let c = 0; c < brickCols; c++){
        if(bricks[r][c]){
          ctx.fillStyle = colors[r];
          ctx.fillRect(c * (brickWidth + 5), r * (brickHeight + 5) + 30, brickWidth, brickHeight);
        }
      }
    }

    // Draw paddle
    ctx.fillStyle = '#fff';
    ctx.fillRect(paddleX, height - paddleHeight, paddleWidth, paddleHeight);

    // Draw ball
    ctx.fillRect(ballX, ballY, ballSize, ballSize);

  }, 1000/60);
}

function pauseBreakout(){
  if(breakoutGame) clearInterval(breakoutGame);
}

// 2048 Game
let game2048Grid = [];
let game2048Score = 0;

function init2048(){
  game2048Grid = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
  game2048Score = 0;
  add2048Tile();
  add2048Tile();
  render2048();
}

function add2048Tile(){
  const empty = [];
  for(let r = 0; r < 4; r++){
    for(let c = 0; c < 4; c++){
      if(game2048Grid[r][c] === 0) empty.push({r, c});
    }
  }
  if(empty.length > 0){
    const pos = empty[Math.floor(Math.random() * empty.length)];
    game2048Grid[pos.r][pos.c] = Math.random() < 0.9 ? 2 : 4;
  }
}

function render2048(){
  const gridEl = document.getElementById('game2048-grid');
  const scoreEl = document.getElementById('game2048-score');

  if(scoreEl) scoreEl.textContent = game2048Score;
  if(!gridEl) return;

  const colors = {
    0: '#cdc1b4', 2: '#eee4da', 4: '#ede0c8', 8: '#f2b179',
    16: '#f59563', 32: '#f67c5f', 64: '#f65e3b', 128: '#edcf72',
    256: '#edcc61', 512: '#edc850', 1024: '#edc53f', 2048: '#edc22e'
  };

  let html = '<div style="display:grid;grid-template-columns:repeat(4,80px);gap:10px;">';
  for(let r = 0; r < 4; r++){
    for(let c = 0; c < 4; c++){
      const val = game2048Grid[r][c];
      const bg = colors[val] || '#3c3a32';
      const fg = val > 4 ? '#f9f6f2' : '#776e65';
      html += `<div style="width:80px;height:80px;background:${bg};color:${fg};display:flex;align-items:center;justify-content:center;font-size:${val > 99 ? '24px' : '32px'};font-weight:bold;border-radius:3px;">${val || ''}</div>`;
    }
  }
  html += '</div>';
  gridEl.innerHTML = html;
}

function move2048(dir){
  let moved = false;
  const rotated = rotate2048Grid(dir);

  for(let r = 0; r < 4; r++){
    let row = rotated[r].filter(x => x !== 0);
    for(let i = 0; i < row.length - 1; i++){
      if(row[i] === row[i + 1]){
        row[i] *= 2;
        game2048Score += row[i];
        row.splice(i + 1, 1);
      }
    }
    while(row.length < 4) row.push(0);

    if(JSON.stringify(row) !== JSON.stringify(rotated[r])){
      moved = true;
      rotated[r] = row;
    }
  }

  game2048Grid = rotate2048Grid((4 - dir) % 4, rotated);

  if(moved){
    add2048Tile();
    render2048();
    playClickSound();
  }
}

function rotate2048Grid(times, grid = game2048Grid){
  let result = grid.map(r => [...r]);
  for(let t = 0; t < times; t++){
    const temp = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
    for(let r = 0; r < 4; r++){
      for(let c = 0; c < 4; c++){
        temp[c][3 - r] = result[r][c];
      }
    }
    result = temp;
  }
  return result;
}

// Add keyboard controls for 2048
document.addEventListener('keydown', e => {
  const grid2048 = document.getElementById('game2048-grid');
  if(!grid2048 || !grid2048.offsetParent) return;

  if(e.key === 'ArrowLeft'){e.preventDefault(); move2048(0);}
  if(e.key === 'ArrowUp'){e.preventDefault(); move2048(1);}
  if(e.key === 'ArrowRight'){e.preventDefault(); move2048(2);}
  if(e.key === 'ArrowDown'){e.preventDefault(); move2048(3);}
});

// System Monitor functions
function refreshSystemMonitor(){
  const cpuBar = document.getElementById('monitor-cpu-bar');
  const cpuText = document.getElementById('monitor-cpu-text');
  const memBar = document.getElementById('monitor-mem-bar');
  const memText = document.getElementById('monitor-mem-text');
  const processes = document.getElementById('monitor-processes');

  const cpu = Math.floor(Math.random() * 60) + 10;
  const mem = Math.floor(Math.random() * 300) + 100;

  if(cpuBar) cpuBar.style.width = cpu + '%';
  if(cpuText) cpuText.textContent = cpu + '%';
  if(memBar) memBar.style.width = (mem / 512 * 100) + '%';
  if(memText) memText.textContent = mem + ' KB / 512 MB';

  if(processes){
    const windows = document.querySelectorAll('.window');
    let html = '<div style="font-size:12px;">';
    windows.forEach(w => {
      const title = w.querySelector('.window-header span').textContent;
      html += `<div style="padding:4px;border-bottom:1px solid #ddd;">${title} - Running</div>`;
    });
    html += '</div>';
    processes.innerHTML = html;
  }

  playClickSound();
}

// Clipboard Manager functions
let clipboardHistory = [];

function clipboardCopy(){
  const input = document.getElementById('clip-input');
  if(!input || !input.value) return;

  clipboardHistory.unshift(input.value);
  if(clipboardHistory.length > 10) clipboardHistory.pop();

  updateClipboardHistory();
  playClickSound();
  alert('Copied to clipboard!');
}

function clipboardPaste(){
  const input = document.getElementById('clip-input');
  if(!input || clipboardHistory.length === 0) return;

  input.value = clipboardHistory[0];
  playClickSound();
}

function clipboardClear(){
  clipboardHistory = [];
  updateClipboardHistory();
  const input = document.getElementById('clip-input');
  if(input) input.value = '';
  playClickSound();
}

function updateClipboardHistory(){
  const history = document.getElementById('clipboard-history');
  if(!history) return;

  let html = '';
  clipboardHistory.forEach((item, i) => {
    html += `<div style="padding:8px;margin-bottom:5px;background:#f0f0f0;border:1px solid #ccc;cursor:pointer;" onclick="document.getElementById('clip-input').value=decodeURIComponent('${encodeURIComponent(item)}'); playClickSound();">
      <strong>Item ${i + 1}:</strong> ${item}
    </div>`;
  });
  history.innerHTML = html || '<div style="color:#999;">No clipboard history</div>';
}

// ========== KEYBOARD SHORTCUTS ==========
document.addEventListener('keydown', e => {
  // Alt+F4 - Close active window
  if(e.altKey && e.key === 'F4'){
    e.preventDefault();
    if(activeWindow){
      activeWindow.remove();
      removeTaskbarItem(activeWindow);
      playCloseSound();
    }
  }

  // Win+D - Show desktop (minimize all)
  if(e.metaKey && e.key === 'd'){
    e.preventDefault();
    document.querySelectorAll('.window').forEach(w => {
      w.classList.add('minimized');
      updateTaskbarItem(w);
    });
    playClickSound();
  }

  // Win+E - Open File Explorer
  if(e.metaKey && e.key === 'e'){
    e.preventDefault();
    createWindow('file-explorer');
  }

  // Ctrl+Alt+Delete - Open Task Manager
  if(e.ctrlKey && e.altKey && e.key === 'Delete'){
    e.preventDefault();
    createWindow('task-manager');
  }
});

// ========== NOTIFICATION AREA ==========
function showNotification(title, message, duration = 3000){
  const notification = document.createElement('div');
  notification.style.cssText = 'position:fixed;bottom:40px;right:20px;background:#fff;border:2px solid #0054E3;padding:10px;min-width:250px;max-width:350px;box-shadow:3px 3px 8px rgba(0,0,0,0.3);z-index:10000;animation:slideInRight 0.3s ease;';
  notification.innerHTML = `
    <div style="font-weight:bold;margin-bottom:5px;">${title}</div>
    <div style="font-size:12px;">${message}</div>
  `;
  document.body.appendChild(notification);

  playClickSound();

  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, duration);
}

// Add notification animations
const notifStyle = document.createElement('style');
notifStyle.textContent = `
  @keyframes slideInRight{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
  @keyframes slideOutRight{from{transform:translateX(0);opacity:1;}to{transform:translateX(400px);opacity:0;}}
`;
document.head.appendChild(notifStyle);

// Show welcome notification on load
setTimeout(() => {
  showNotification('◊ë◊®◊ï◊õ◊ô◊ù ◊î◊ë◊ê◊ô◊ù ◊ú-Windows XP!', '◊°◊ô◊û◊ï◊ú◊ò◊ï◊® ◊û◊©◊ï◊§◊® ◊¢◊ù ◊ê◊§◊ú◊ô◊ß◊¶◊ô◊ï◊™ ◊ï◊û◊©◊ó◊ß◊ô◊ù ◊ó◊ì◊©◊ô◊ù');
}, 1000);

// ========== VIRTUAL FILE SYSTEM ==========
class VirtualFileSystem {
  constructor() {
    this.loadFromStorage();
  }

  loadFromStorage() {
    const stored = localStorage.getItem('xp-filesystem');
    if (stored) {
      this.root = JSON.parse(stored);
    } else {
      this.initializeDefaultStructure();
    }
  }

  saveToStorage() {
    localStorage.setItem('xp-filesystem', JSON.stringify(this.root));
  }

  initializeDefaultStructure() {
    this.root = {
      name: 'C:',
      type: 'drive',
      children: {
        'Desktop': { type: 'folder', children: {} },
        'My Documents': {
          type: 'folder',
          children: {
            'Welcome.txt': {
              type: 'file',
              content: 'Welcome to Windows XP Virtual File System!\nYou can now create, edit, and manage real files.',
              created: Date.now(),
              modified: Date.now()
            },
            'Resume.txt': {
              type: 'file',
              content: 'My Resume\n\nName: User\nEmail: user@windowsxp.com',
              created: Date.now(),
              modified: Date.now()
            }
          }
        },
        'My Pictures': {
          type: 'folder',
          children: {
            'sample.png': {
              type: 'file',
              fileType: 'image',
              content: 'https://picsum.photos/400/300',
              created: Date.now(),
              modified: Date.now()
            }
          }
        },
        'My Music': { type: 'folder', children: {} },
        'Program Files': {
          type: 'folder',
          children: {
            'Windows': { type: 'folder', children: {} },
            'Internet Explorer': { type: 'folder', children: {} }
          }
        }
      }
    };

    // Initialize Recycle Bin separately
    const recycleData = localStorage.getItem('xp-recycle-bin');
    if (!recycleData) {
      localStorage.setItem('xp-recycle-bin', JSON.stringify([]));
    }

    this.saveToStorage();
  }

  navigatePath(path) {
    if (path === 'C:' || path === 'C:\\') return this.root;

    const parts = path.replace(/^C:\\?/, '').split('\\').filter(p => p);
    let current = this.root;

    for (const part of parts) {
      if (!current.children || !current.children[part]) {
        return null;
      }
      current = current.children[part];
    }

    return current;
  }

  listDirectory(path) {
    const dir = this.navigatePath(path);
    if (!dir || dir.type !== 'folder' && dir.type !== 'drive') return null;
    return dir.children || {};
  }

  createFile(path, filename, content = '', fileType = 'text') {
    const dir = this.navigatePath(path);
    if (!dir || (dir.type !== 'folder' && dir.type !== 'drive')) return false;

    if (!dir.children) dir.children = {};

    dir.children[filename] = {
      type: 'file',
      fileType: fileType,
      content: content,
      created: Date.now(),
      modified: Date.now()
    };

    this.saveToStorage();
    return true;
  }

  createFolder(path, foldername) {
    const dir = this.navigatePath(path);
    if (!dir || (dir.type !== 'folder' && dir.type !== 'drive')) return false;

    if (!dir.children) dir.children = {};

    if (dir.children[foldername]) return false; // Already exists

    dir.children[foldername] = {
      type: 'folder',
      children: {},
      created: Date.now(),
      modified: Date.now()
    };

    this.saveToStorage();
    return true;
  }

  readFile(path, filename) {
    const dir = this.navigatePath(path);
    if (!dir || !dir.children || !dir.children[filename]) return null;

    const file = dir.children[filename];
    if (file.type !== 'file') return null;

    return file;
  }

  writeFile(path, filename, content) {
    const dir = this.navigatePath(path);
    if (!dir || !dir.children || !dir.children[filename]) return false;

    const file = dir.children[filename];
    if (file.type !== 'file') return false;

    file.content = content;
    file.modified = Date.now();

    this.saveToStorage();
    return true;
  }

  deleteItem(path, itemname) {
    const dir = this.navigatePath(path);
    if (!dir || !dir.children || !dir.children[itemname]) return false;

    // Move to recycle bin
    const item = dir.children[itemname];
    const recycleBin = JSON.parse(localStorage.getItem('xp-recycle-bin') || '[]');

    recycleBin.push({
      name: itemname,
      path: path,
      item: item,
      deletedDate: Date.now()
    });

    localStorage.setItem('xp-recycle-bin', JSON.stringify(recycleBin));

    delete dir.children[itemname];
    this.saveToStorage();
    return true;
  }

  renameItem(path, oldname, newname) {
    const dir = this.navigatePath(path);
    if (!dir || !dir.children || !dir.children[oldname]) return false;
    if (dir.children[newname]) return false; // Name already exists

    dir.children[newname] = dir.children[oldname];
    delete dir.children[oldname];

    this.saveToStorage();
    return true;
  }

  copyItem(sourcePath, itemname, destPath) {
    const sourceDir = this.navigatePath(sourcePath);
    const destDir = this.navigatePath(destPath);

    if (!sourceDir || !destDir || !sourceDir.children || !sourceDir.children[itemname]) return false;

    if (!destDir.children) destDir.children = {};

    // Deep clone the item
    destDir.children[itemname] = JSON.parse(JSON.stringify(sourceDir.children[itemname]));

    this.saveToStorage();
    return true;
  }

  moveItem(sourcePath, itemname, destPath) {
    if (this.copyItem(sourcePath, itemname, destPath)) {
      const sourceDir = this.navigatePath(sourcePath);
      delete sourceDir.children[itemname];
      this.saveToStorage();
      return true;
    }
    return false;
  }

  emptyRecycleBin() {
    localStorage.setItem('xp-recycle-bin', JSON.stringify([]));
    return true;
  }

  restoreFromRecycleBin(index) {
    const recycleBin = JSON.parse(localStorage.getItem('xp-recycle-bin') || '[]');
    if (index < 0 || index >= recycleBin.length) return false;

    const recycled = recycleBin[index];
    const dir = this.navigatePath(recycled.path);

    if (!dir) return false;

    if (!dir.children) dir.children = {};
    dir.children[recycled.name] = recycled.item;

    recycleBin.splice(index, 1);
    localStorage.setItem('xp-recycle-bin', JSON.stringify(recycleBin));

    this.saveToStorage();
    return true;
  }

  getRecycleBinItems() {
    return JSON.parse(localStorage.getItem('xp-recycle-bin') || '[]');
  }
}

// Initialize the file system
const vfs = new VirtualFileSystem();

// ========== NEW APPLICATIONS FUNCTIONS ==========

// MP3 Player functions
let mp3Playlist = [];
document.addEventListener('DOMContentLoaded', function(){
  const fileInput = document.getElementById('mp3-file');
  if(fileInput){
    fileInput.addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
        const audio = document.getElementById('mp3-audio');
        const info = document.getElementById('mp3-info');
        const url = URL.createObjectURL(file);
        audio.src = url;
        info.textContent = `Now playing: ${file.name}`;
        mp3Playlist.push({name: file.name, url: url});
        updatePlaylist();
        playClickSound();
      }
    });
  }
});

function updatePlaylist(){
  const playlistDiv = document.getElementById('mp3-playlist');
  if(!playlistDiv || mp3Playlist.length === 0) return;
  let html = '';
  mp3Playlist.forEach((track, i) => {
    html += `<div style="padding:8px;background:rgba(255,255,255,0.1);margin-bottom:5px;border-radius:4px;cursor:pointer;" onclick="playTrack(${i})">
      ${i + 1}. ${track.name}
    </div>`;
  });
  playlistDiv.innerHTML = html;
}

function playTrack(index){
  if(index >= 0 && index < mp3Playlist.length){
    const audio = document.getElementById('mp3-audio');
    const info = document.getElementById('mp3-info');
    audio.src = mp3Playlist[index].url;
    audio.play();
    info.textContent = `Now playing: ${mp3Playlist[index].name}`;
    playClickSound();
  }
}

function clearPlaylist(){
  mp3Playlist = [];
  const playlistDiv = document.getElementById('mp3-playlist');
  if(playlistDiv){
    playlistDiv.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">Playlist Empty</div>';
  }
  const audio = document.getElementById('mp3-audio');
  if(audio) audio.src = '';
  const info = document.getElementById('mp3-info');
  if(info) info.textContent = 'No file loaded';
  playClickSound();
}

// Image Viewer functions
let imageRotation = 0;
let imageZoom = 1;
let currentImageSrc = '';

document.addEventListener('DOMContentLoaded', function(){
  const imageInput = document.getElementById('image-file');
  if(imageInput){
    imageInput.addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(event){
          currentImageSrc = event.target.result;
          imageRotation = 0;
          imageZoom = 1;
          displayImage();
          playClickSound();
        };
        reader.readAsDataURL(file);
      }
    });
  }
});

function displayImage(){
  const container = document.getElementById('image-container');
  if(!container || !currentImageSrc) return;
  container.innerHTML = `<img src="${currentImageSrc}" style="max-width:100%;max-height:100%;transform:rotate(${imageRotation}deg) scale(${imageZoom});transition:transform 0.3s;">`;
}

function rotateImage(degrees){
  imageRotation += degrees;
  displayImage();
  playClickSound();
}

function zoomImage(factor){
  imageZoom *= factor;
  if(imageZoom < 0.1) imageZoom = 0.1;
  if(imageZoom > 5) imageZoom = 5;
  displayImage();
  playClickSound();
}

function resetImage(){
  imageRotation = 0;
  imageZoom = 1;
  displayImage();
  playClickSound();
}

// Advanced Text Editor functions
function updateEditorStats(){
  const text = document.getElementById('advanced-editor-text');
  const stats = document.getElementById('editor-stats');
  const lineNumbers = document.getElementById('editor-line-numbers');

  if(!text || !stats) return;

  const content = text.value;
  const lines = content.split('\\n');
  const words = content.trim() ? content.trim().split(/\\s+/).length : 0;
  const chars = content.length;

  stats.textContent = `Lines: ${lines.length} | Words: ${words} | Chars: ${chars}`;

  if(lineNumbers){
    let lineNums = '';
    for(let i = 1; i <= lines.length; i++){
      lineNums += i + '\\n';
    }
    lineNumbers.textContent = lineNums;
  }
}

function editorNew(){
  const text = document.getElementById('advanced-editor-text');
  if(text && confirm('Create new file? Unsaved changes will be lost.')){
    text.value = '';
    updateEditorStats();
    playClickSound();
  }
}

function editorSave(){
  const text = document.getElementById('advanced-editor-text');
  if(!text) return;

  const filename = prompt('Enter filename:', 'document.txt');
  if(filename){
    vfs.createFile(cmdCurrentPath, filename, text.value);
    alert(`Saved as ${filename}`);
    playClickSound();
  }
}

function editorLoad(){
  const filename = prompt('Enter filename to load:');
  if(filename){
    const file = vfs.readFile(cmdCurrentPath, filename);
    if(file){
      const text = document.getElementById('advanced-editor-text');
      if(text){
        text.value = file.content;
        updateEditorStats();
        playClickSound();
      }
    } else {
      alert('File not found');
      playErrorSound();
    }
  }
}

function updateEditorHighlight(){
  // Placeholder for syntax highlighting
  playClickSound();
}

function toggleWrap(){
  const text = document.getElementById('advanced-editor-text');
  const checkbox = document.getElementById('editor-wrap');
  if(text && checkbox){
    text.style.whiteSpace = checkbox.checked ? 'pre-wrap' : 'pre';
    text.style.overflowWrap = checkbox.checked ? 'break-word' : 'normal';
    playClickSound();
  }
}

// Scientific Calculator functions
let sciCalcExpression = '';

function sciCalcClick(value){
  const display = document.getElementById('sci-calc-display');
  if(!display) return;

  if(value === 'sin' || value === 'cos' || value === 'tan' || value === 'log' || value === 'ln' || value === 'sqrt'){
    sciCalcExpression += value + '(';
  } else if(value === 'pow'){
    sciCalcExpression += '^2';
  } else {
    sciCalcExpression += value;
  }

  display.value = sciCalcExpression;
  playClickSound();
}

function sciCalcClear(){
  sciCalcExpression = '';
  const display = document.getElementById('sci-calc-display');
  if(display) display.value = '';
  playClickSound();
}

function sciCalcEquals(){
  const display = document.getElementById('sci-calc-display');
  if(!display) return;

  try {
    let expr = sciCalcExpression;
    expr = expr.replace(/sin\\(/g, 'Math.sin(');
    expr = expr.replace(/cos\\(/g, 'Math.cos(');
    expr = expr.replace(/tan\\(/g, 'Math.tan(');
    expr = expr.replace(/log\\(/g, 'Math.log10(');
    expr = expr.replace(/ln\\(/g, 'Math.log(');
    expr = expr.replace(/sqrt\\(/g, 'Math.sqrt(');
    expr = expr.replace(/\\^2/g, '**2');

    const result = eval(expr);
    display.value = result;
    sciCalcExpression = result.toString();
    playClickSound();
  } catch(e) {
    display.value = 'Error';
    playErrorSound();
    setTimeout(() => {
      sciCalcExpression = '';
      display.value = '';
    }, 1500);
  }
}

// Clock & Timer functions
let stopwatchInterval = null;
let stopwatchTime = 0;
let timerInterval = null;
let timerTime = 0;

function updateClock(){
  const timeEl = document.getElementById('clock-time');
  const dateEl = document.getElementById('clock-date');
  if(!timeEl) return;

  const now = new Date();
  timeEl.textContent = now.toLocaleTimeString();
  if(dateEl){
    dateEl.textContent = now.toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
  }
}

function startStopwatch(){
  if(stopwatchInterval) return;
  stopwatchInterval = setInterval(() => {
    stopwatchTime++;
    updateStopwatchDisplay();
  }, 1000);
  playClickSound();
}

function stopStopwatch(){
  if(stopwatchInterval){
    clearInterval(stopwatchInterval);
    stopwatchInterval = null;
    playClickSound();
  }
}

function resetStopwatch(){
  stopStopwatch();
  stopwatchTime = 0;
  updateStopwatchDisplay();
  playClickSound();
}

function updateStopwatchDisplay(){
  const display = document.getElementById('stopwatch-display');
  if(!display) return;
  const hours = Math.floor(stopwatchTime / 3600);
  const minutes = Math.floor((stopwatchTime % 3600) / 60);
  const seconds = stopwatchTime % 60;
  display.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

function startTimer(){
  const input = document.getElementById('timer-input');
  if(!input || !input.value) return;

  if(timerInterval) clearInterval(timerInterval);

  timerTime = parseInt(input.value);
  timerInterval = setInterval(() => {
    timerTime--;
    updateTimerDisplay();
    if(timerTime <= 0){
      clearInterval(timerInterval);
      timerInterval = null;
      alert('Timer finished!');
      playErrorSound();
    }
  }, 1000);
  playClickSound();
}

function stopTimer(){
  if(timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
    playClickSound();
  }
}

function resetTimer(){
  stopTimer();
  timerTime = 0;
  updateTimerDisplay();
  playClickSound();
}

function updateTimerDisplay(){
  const display = document.getElementById('timer-display');
  if(!display) return;
  const minutes = Math.floor(timerTime / 60);
  const seconds = timerTime % 60;
  display.textContent = `${pad(minutes)}:${pad(seconds)}`;
}

function pad(num){
  return num.toString().padStart(2, '0');
}

// Todo List functions
let todos = JSON.parse(localStorage.getItem('todos')) || [];
let todoFilter = 'all';

function addTodo(){
  const input = document.getElementById('todo-input');
  if(!input || !input.value.trim()) return;

  todos.push({
    id: Date.now(),
    text: input.value.trim(),
    completed: false,
    createdAt: new Date().toISOString()
  });

  input.value = '';
  saveTodos();
  renderTodos();
  playClickSound();
}

function toggleTodo(id){
  const todo = todos.find(t => t.id === id);
  if(todo){
    todo.completed = !todo.completed;
    saveTodos();
    renderTodos();
    playClickSound();
  }
}

function deleteTodo(id){
  todos = todos.filter(t => t.id !== id);
  saveTodos();
  renderTodos();
  playClickSound();
}

function filterTodos(filter){
  todoFilter = filter;
  renderTodos();

  ['all', 'active', 'completed'].forEach(f => {
    const btn = document.getElementById('filter-' + f);
    if(btn){
      if(f === filter){
        btn.style.background = '#6c757d';
        btn.style.color = '#fff';
        btn.style.border = 'none';
      } else {
        btn.style.background = '#f8f9fa';
        btn.style.color = '#000';
        btn.style.border = '1px solid #ddd';
      }
    }
  });

  playClickSound();
}

function clearCompleted(){
  todos = todos.filter(t => !t.completed);
  saveTodos();
  renderTodos();
  playClickSound();
}

function saveTodos(){
  localStorage.setItem('todos', JSON.stringify(todos));
}

function renderTodos(){
  const list = document.getElementById('todo-list');
  const count = document.getElementById('todo-count');
  if(!list) return;

  let filteredTodos = todos;
  if(todoFilter === 'active') filteredTodos = todos.filter(t => !t.completed);
  if(todoFilter === 'completed') filteredTodos = todos.filter(t => t.completed);

  if(filteredTodos.length === 0){
    list.innerHTML = '<div style="color:#999;text-align:center;padding:40px 20px;">No tasks yet. Add one above!</div>';
  } else {
    let html = '';
    filteredTodos.forEach(todo => {
      html += `<div style="padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;">
        <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})" style="width:18px;height:18px;cursor:pointer;">
        <span style="flex:1;${todo.completed ? 'text-decoration:line-through;color:#999;' : ''}">${todo.text}</span>
        <button onclick="deleteTodo(${todo.id})" style="padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:3px;cursor:pointer;">Delete</button>
      </div>`;
    });
    list.innerHTML = html;
  }

  if(count){
    const activeCount = todos.filter(t => !t.completed).length;
    count.textContent = `${activeCount} active task${activeCount !== 1 ? 's' : ''}`;
  }
}

// Initialize clock updates
setInterval(updateClock, 1000);
updateClock();

// Initialize apps when windows are created
const originalCreateWindow = createWindow;

</script>
</body></html>
